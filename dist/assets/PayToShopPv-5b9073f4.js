import{u as oe,a as ae,r,s as ie,b as re,c as A,f as h,F as le,j as s,g as E}from"./index-a90aa29c.js";import{u as b,w as pe}from"./xlsx-9a117414.js";import{F as ce,a as _e}from"./formik.esm-c4fd04ca.js";import{Q as de}from"./index-2f30bf27.js";import{S as O}from"./react-select.esm-b46d9623.js";import{P as me}from"./preLoading-b2445d9d.js";import{t as ue,h as N}from"./constant-e85f1578.js";import{B as he}from"./breadcrumbs-b9914bbc.js";import{S as be}from"./sweetalert2.all-ca2d1030.js";import{D as ge}from"./DateRangeAntd-92e3cf4d.js";import{S as Se}from"./SelectField-917481a8.js";import"./floating-ui.dom-0aeb9e8a.js";import"./createSuper-98fcd92d.js";import"./buddhistEra-a2d9672b.js";import"./index-8d8bdff8.js";import"./lodash-f7ec5310.js";const Ae=be.mixin(ue),Ee={id_business_unit:"",start_at:"",end_at:"",contract_date:["",""]},x="admin",He=()=>{oe();const f=ae(),M="https://dev-tms-admin.gsrental.cn:7443/api/v1",_=localStorage.getItem(x),m=_?JSON.parse(_).role:null,k=_?JSON.parse(_).access_token:null,U=_?JSON.parse(_).id_business_unit:null,w=[{to:"/",label:"รายงาน"},{label:"จ่ายเงินให้ร้านค้า (PV)",isCurrent:!0}];r.useEffect(()=>{f(ie("รายงานจ่ายเงินให้ร้านค้า (PV)")),f(re(["report","/apps/report/pay-to-shop-pv"]))});const{mutate:I,isLoading:H}=A(E.leasingReportPVFindAll,{onSuccess:e=>{if(e.statusCode==200){const t=e.data.list.reduce((o,i)=>(o.amount+=i.amount||0,o.commission+=i.commission||0,o.down_payment+=i.down_payment||0,o.fee+=i.fee||0,o.price+=i.price||0,o.principle+=i.principle||0,o.total+=i.total||0,o.benefit+=i.benefit||0,o),{amount:0,commission:0,down_payment:0,fee:0,price:0,principle:0,total:0,benefit:0}),a=e.data.list.concat({...t,isTotal:!0});e.data.list.length>0?L(a):L([]),F(e.data.total)}},onError:()=>{console.error("Failed to fetch asset type data")}}),[Te,P]=r.useState(!1),[R,v]=r.useState(!1),D=[10,20,30,50,100],[j,C]=r.useState([]),[g,T]=r.useState(1),[u,V]=r.useState(D[0]),[G,F]=r.useState(0),[p,B]=r.useState([]),[K,L]=r.useState([]),[l,W]=r.useState(Ee),[Y,$]=r.useState({columnAccessor:"",direction:"asc"}),z=(e,t,a)=>{P(!0);const o=m==="business_unit"?U:l.id_business_unit;I({data:{page:t,page_size:a,start_at:e.start_at,end_at:e.end_at,id_business_unit:o,id_shop:e.id_shop,query:e.query}})},{mutate:X}=A(E.contractFilter,{onSuccess:e=>{B(e.data.business_unit.map(t=>({value:t,label:t.name})))},onError:()=>{console.error("Failed to fetch asset type data")}}),S=(e,t)=>{W(a=>({...a,[t]:e}))},q=async e=>{var i;const t=new Headers;t.append("Content-Type","application/json"),t.append("Authorization",`Bearer ${k}`);const a=JSON.stringify({id_business_unit:m==="business_unit"?U:(i=e.id_business_unit)==null?void 0:i.value.id,page:1,page_size:5e4,start_at:e.contract_date[0],end_at:e.contract_date[1],id_shop:e.id_shop}),o={method:"POST",headers:t,body:a,redirect:"follow"};return fetch(M+"/admin/pv/leasing-report",o).then(c=>c.json()).then(c=>c.data).catch(c=>[])},Z=async(e,t)=>{if(!R){v(!0);const a=await q(t),o=a.list.reduce((n,y)=>n+y.count_contract,0);a.list=[{no:0,business_unit_name:"",shop_name:"",count_contract:0,price:0,down_payment:0,principle:0,commission:0,benefit:0,amount:0,fee:0,total:0,bank_name:"",bank_account_name:"",bank_account_number:""},...a.list];const i=b.json_to_sheet(a.list.map((n,y)=>({no:y,business_unit_name:n.business_unit_name,shop_name:n.shop_name,count_contract:n.count_contract.toLocaleString("en-US"),price:n.price.toLocaleString("en-US"),down_payment:n.down_payment.toLocaleString("en-US"),principle:n.principle.toLocaleString("en-US"),commission:n.commission.toLocaleString("en-US"),benefit:n.benefit.toLocaleString("en-US"),amount:n.amount.toLocaleString("en-US"),fee:n.fee.toLocaleString("en-US"),total:n.total.toLocaleString("en-US"),bank_name:(n==null?void 0:n.bank_name)||"-",bank_account_name:(n==null?void 0:n.bank_account_name)||"-",bank_account_number:(n==null?void 0:n.bank_account_number)||"-"})),{header:N.map(n=>n.id)}),c=b.book_new();b.book_append_sheet(c,i,"Sheet1");const ee=N.map(n=>n.displayName);b.sheet_add_aoa(i,[["ระหว่างวันที่",`${t.contract_date[0]} - ${t.contract_date[1]}`,"","","","","","","","","","","","จำนวนสัญญา",o]],{origin:"A1"}),b.sheet_add_aoa(i,[ee],{origin:"A2"});const te=pe(c,{bookType:"xlsx",type:"array"}),se=new Blob([te],{type:"application/octet-stream"}),d=document.createElement("a"),ne=URL.createObjectURL(se);d.setAttribute("href",ne),d.setAttribute("download",e+".xlsx"),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d),v(!1)}},{mutate:J}=A(E.shopFindAll,{onSuccess:e=>{C(e.data.list.map(t=>({value:t.id,label:t.name})))},onError:()=>{console.error("Failed to fetch asset type data")}});r.useEffect(()=>{m!="admin"&&J({})},[]),r.useEffect(()=>{if(l.id_business_unit===""){X({});return}I({data:{page:g,page_size:u,id_business_unit:l.id_business_unit,start_at:l.start_at,end_at:l.end_at,id_shop:l.id_shop}})},[g,u]);const{mutate:Q}=A(E.buGetShop,{onSuccess:e=>{const t=e.data.map(a=>({value:a.uuid,label:a.name}));C(t)},onError:()=>{}});return h(le,{children:[s(he,{items:w}),(H||R)&&s(me,{}),h("div",{className:"panel px-0 border-white-light dark:border-[#1b2e4b] mt-5",children:[s("div",{children:s(ce,{initialValues:l,onSubmit:e=>{const t=m==="business_unit"?!1:e.id_business_unit==="";e.contract_date[0]===""||e.contract_date[1]===""||t?Ae.fire({icon:"warning",title:"กรุณาเลือกข้อมูลวันที่และหน่วยธุรกิจให้ครบเพื่อค้นหา",padding:"10px 20px"}):(P(!0),T(1),S(e.contract_date[0],"start_at"),S(e.contract_date[1],"end_at"),S(e.id_shop,"id_shop"),z({...e,id_shop:e.id_shop,start_at:e.contract_date[0],end_at:e.contract_date[1]},1,u))},children:({values:e,setFieldValue:t,resetForm:a})=>s(_e,{className:"flex flex-col flex-auto gap-2",children:h("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5 mb-5 px-5",children:[h("div",{className:"flex-1",children:[s("label",{children:"หน่วยธุรกิจ"}),m==="business_unit"?s(O,{defaultValue:p.length===0?null:{label:p[0].label,value:p[0].value.id},value:p.length===0?null:{label:p[0].label,value:p[0].value.id},placeholder:"เลือก หน่วยธุรกิจ",className:"z-10 w-auto",options:p.map(o=>({label:o.label,value:o.value.id})),isDisabled:!0}):s(O,{value:e.id_business_unit,placeholder:"เลือก หน่วยธุรกิจ",className:"z-10 w-auto",options:p,isSearchable:!0,onChange:o=>{t("id_business_unit",o),S(o.value.id,"id_business_unit"),Q({data:{id_business_unit:o.value.id}})}})]}),s(Se,{isSearchable:!0,label:"ร้านค้า",id:"id_shop",name:"id_shop",placeholder:"เลือกร้านค้า",options:j,zIndex:"z-4"}),s(ge,{label:"วันที่ทำสัญญา",name:"contract_date"}),s("div",{className:"flex flex-col mt-1 pt-5",children:s("button",{type:"submit",className:"btn btn-primary gap-2 w-full h-[40px]",children:"ค้นหา"})}),s("div",{className:"flex flex-col mt-1 pt-5",children:s("button",{type:"reset",className:"btn btn-info gap-2 w-full h-[40px]",onClick:()=>{location.reload()},children:"ล้างค่า"})}),s("div",{className:"flex flex-col mt-1 pt-5",children:s("button",{type:"button",className:"btn btn-success gap-2 w-full h-[40px]",onClick:()=>{Z(`report_${new Date().toLocaleString()}`,e)},children:"Export"})})]})})})}),s("div",{className:"invoice-table px-5",children:h("div",{className:"datatables pagination-padding",children:[x==="business_unit",s(de,{className:"whitespace-nowrap table-hover invoice-table",records:K,columns:[{accessor:"id",title:"ลำดับ",textAlignment:"center",sortable:!1,render:(e,t)=>e.isTotal?null:t+1+(g-1)*u},{accessor:"business_unit_name",title:"หน่วยธุรกิจ",textAlignment:"left",sortable:!1,render:e=>s("p",{children:e.business_unit_name})},{accessor:"shop_name",title:"ร้านค้า",textAlignment:"left",sortable:!1,render:e=>s("div",{className:"flex items-center font-normal",children:s("a",{className:"flex cursor-pointer active",href:`/apps/report/pay-to-shop-pv/shop/${e.id_shop}?startDate=${l.start_at}&endDate=${l.end_at}&id_business_unit=${l.id_business_unit}`,target:"_blank",children:s("div",{children:e.shop_name})})})},{accessor:"count_contract",title:"จำนวนสัญญา",textAlignment:"center",sortable:!1,render:(e,t)=>s("p",{children:e.isTotal?"ผลรวม":e.count_contract})},{accessor:"price",title:"รวมราคาขาย",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.isTotal?`${e.price.toLocaleString("en-US")} บาท`:e.price.toLocaleString("en-US")})},{accessor:"down_payment",title:"รวมเงินดาวน์",textAlignment:"right",sortable:!1,render:(e,t)=>s("div",{children:e.isTotal?`${e.down_payment.toLocaleString("en-US")} บาท`:e.down_payment.toLocaleString("en-US")})},{accessor:"principle",title:"รวมทุนเช่าซื้อ",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.isTotal?`${e.principle.toLocaleString("en-US")} บาท`:e.principle.toLocaleString("en-US")})},{accessor:"commission",title:"รวมค่านายหน้า",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.isTotal?`${e.commission.toLocaleString("en-US")} บาท`:e.commission.toLocaleString("en-US")})},{accessor:"benefit",title:"ผลตอบแทนพิเศษ",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.isTotal?`${e.benefit.toLocaleString("en-US")} บาท`:e.benefit.toLocaleString("en-US")})},{accessor:"amount",title:"รวมเป็นเงิน",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.isTotal?`${e.amount.toLocaleString("en-US")} บาท`:e.amount.toLocaleString("en-US")})},{accessor:"fee",title:"ค่าทำสัญญา",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.isTotal?`${e.fee.toLocaleString("en-US")} บาท`:e.fee.toLocaleString("en-US")||""})},{accessor:"total",title:"คงเหลือให้ร้านค้า",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.isTotal?`${e.total.toLocaleString("en-US")} บาท`:e.total.toLocaleString("en-US")})}],page:g,totalRecords:G,recordsPerPage:u,onPageChange:e=>T(e),recordsPerPageOptions:D,onRecordsPerPageChange:e=>{T(1),V(e)},rowClassName:e=>e.isTotal?"!bg-white font-bold text-black":"",sortStatus:Y,onSortStatusChange:$,paginationText:({from:e,to:t,totalRecords:a})=>`โชว์ ${e} ถึง ${t} ของ ${a} หน้าทั้งหมด`})]})})]})]})};export{He as default};

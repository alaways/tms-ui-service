import{a as ne,u as ae,r as o,c as D,s as oe,b as re,f as d,j as t,g as A}from"./index-a90aa29c.js";import{u,w as ie}from"./xlsx-9a117414.js";import{t as le,l as pe,m as U}from"./constant-e85f1578.js";import{P as C}from"./config-8de56c22.js";import{n as x}from"./formatNumeric-862380d6.js";import{c as O,b as N,a as L}from"./formatDate-4e046265.js";import{F as ce,a as de}from"./formik.esm-c4fd04ca.js";import{Q as _e}from"./index-2f30bf27.js";import{S as me}from"./sweetalert2.all-ca2d1030.js";import{F as M}from"./DatePicker-5cf5930a.js";import{S as k}from"./SelectField-917481a8.js";/* empty css              */import{P as he}from"./preLoading-b2445d9d.js";import{I as ue}from"./InputField-d7971719.js";import"./floating-ui.dom-0aeb9e8a.js";import"./flatpickr-2301360e.js";import"./react-select.esm-b46d9623.js";import"./createSuper-98fcd92d.js";import"./lodash-f7ec5310.js";const b="admin",y=me.mixin(le),Me=()=>{const g=ne(),H=ae(),w="https://dev-tms-admin.gsrental.cn:7443/api/v1",E=localStorage.getItem(b),a=E?JSON.parse(E):null;a&&(a==null||a.role);const j=a?a==null?void 0:a.access_token:null,[T,_]=o.useState(!1),[m,h]=o.useState(1),[G,V]=o.useState(1),[i,F]=o.useState(C[0]),[K,B]=o.useState(0),[W,Y]=o.useState([]),[S,f]=o.useState([]),v={start_at:null,end_at:null,id_business_unit:(a==null?void 0:a.id_business_unit)||null,query:"",status:""},[P,I]=o.useState(v),z=async e=>{const s=new Headers;s.append("Content-Type","application/json"),s.append("Authorization",`Bearer ${j}`);const l=JSON.stringify({...e,page:1,page_size:5e4}),r={method:"POST",headers:s,body:l,redirect:"follow"};return fetch(w+A.invoiceFindAll,r).then(p=>p.json()).then(p=>p.data).catch(p=>[])},X=async(e,s)=>{if(!T){_(!0),(s.start_at===null||s.end_at===null)&&(_(!1),y.fire({icon:"warning",title:"กรุณาเลือกข้อมูลวันที่ให้ครบเพื่อดาวน์โหลด",padding:"10px 20px"})),(s.start_at===null||s.end_at===null)&&(_(!1),y.fire({icon:"warning",title:"กรุณาเลือกข้อมูลวันที่ให้ครบเพื่อดาวน์โหลด",padding:"10px 20px"}));const l=await z(s),r=u.json_to_sheet(l.list.map((n,se)=>({...n,index:se+1,date:N(n==null?void 0:n.date),amount:x(n==null?void 0:n.amount),payed_at:L(n==null?void 0:n.payed_at),status:n.status==="complete"?"สำเร็จ":n.status==="pending"?"รอชำระ":"ยกเลิก"})),{header:U.map(n=>n.id)}),p=u.book_new();u.book_append_sheet(p,r,"Sheet1");const J=U.map(n=>n.displayName);u.sheet_add_aoa(r,[J],{origin:"A1"});const $=ie(p,{bookType:"xlsx",type:"array"}),ee=new Blob([$],{type:"application/octet-stream"}),c=document.createElement("a"),te=URL.createObjectURL(ee);c.setAttribute("href",te),c.setAttribute("download",e+".xlsx"),c.style.visibility="hidden",document.body.appendChild(c),c.click(),document.body.removeChild(c),_(!1)}},{mutate:q}=D(A.businessUnitFindAll,{onSuccess:e=>{Y(e.data.list.map(s=>({value:s.id,label:s.name})))},onError:()=>{console.error("Failed to fetch bu data")}}),{mutate:R,isLoading:Z}=D(A.invoiceFindAll,{onSuccess:e=>{f(e.data.list),B(e.data.total)},onError:()=>{console.error("Failed to fetch payment bu data")}}),Q=e=>{e.id_business_unit===null?y.fire({icon:"warning",title:"กรุณาเลือกหน่วยธุรกิจเพื่อค้นหา",padding:"10px 20px"}):(h(1),I({...e}),R({data:{...e,page:1,page_size:i}}))};return o.useEffect(()=>{R({data:{...P,page:G!==i?1:m,page_size:i}}),V(i)},[m,i]),o.useEffect(()=>{q({data:{page:1,page_size:-1}}),g(oe("ใบแจ้งหนี้")),g(re(["finance","/apps/finance/invoice"]))},[g,b,H]),d("div",{className:"panel px-0 border-white-light dark:border-[#1b2e4b]",children:[(Z||T)&&t(he,{}),d("div",{className:"invoice-table",children:[t("div",{className:"ml-7 my-5 text-lg font-semibold ltr:sm:text-left rtl:sm:text-right text-center flex flex-row justify-between",children:"ใบแจ้งหนี้"}),t("div",{className:"mb-4.5 px-5 md:items-center md:flex-row flex-col gap-5",children:t(ce,{initialValues:P,onSubmit:Q,onReset:()=>{I(v),h(1),f([])},children:({setFieldValue:e,handleReset:s,values:l})=>d(de,{className:"flex flex-col flex-auto gap-2",children:[d("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5",children:[t("div",{className:"flex-1 z-10",children:t(k,{id:"id_business_unit",label:"หน่วยธุรกิจ",name:"id_business_unit",placeholder:"เลือก หน่วยธุรกิจ",options:W,disabled:b!=="admin"})}),t("div",{className:"flex-1 z-10",children:t(k,{id:"status",label:"สถานะการชำระเงิน",name:"status",options:pe})}),t("div",{className:"flex-1",children:t(ue,{label:"ค้นหา",placeholder:"ค้นหา",name:"query",type:"text"})})]}),d("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5",children:[t(M,{label:"วันที่เริ่ม",name:"start_at",onChange:r=>{e("start_at",O(r))}}),t(M,{label:"วันที่สิ้นสุด",name:"end_at",onChange:r=>{e("end_at",O(r))}}),t("button",{type:"submit",className:"btn btn-primary gap-2 mt-5",children:"ค้นหา"}),t("button",{type:"reset",className:"btn btn-info gap-2 mt-5",onClick:s,children:"ล้างค่า"}),t("div",{className:"flex flex-col pt-5",children:t("button",{type:"button",className:"btn btn-success gap-2 w-full h-[40px]",onClick:()=>X(`invoice_history_${new Date().toLocaleString()}`,l),children:"Export"})})]})]})})}),t("div",{className:"datatables pagination-padding",children:S.length===0?t("div",{className:"text-center text-gray-500",children:"ไม่พบข้อมูล"}):t(_e,{className:"whitespace-nowrap table-hover invoice-table",records:S.map((e,s)=>({...e,key:s})),columns:[{accessor:"index",title:"ลำดับ",textAlignment:"center",sortable:!1,render:(e,s)=>t("p",{children:s+1+(m-1)*i})},{accessor:"id",title:"เลขที่",textAlignment:"center",sortable:!1,render:(e,s)=>t("p",{children:(e==null?void 0:e.id)??"-"})},{accessor:"invoice_date",title:"วันที่",textAlignment:"center",sortable:!1,render:(e,s)=>t("p",{children:N(e==null?void 0:e.invoice_date)})},{accessor:"invoice_type",title:"ประเภทใบแจ้งหนี้",textAlignment:"center",sortable:!1,render:(e,s)=>t("p",{children:(e==null?void 0:e.invoice_type)??"-"})},{accessor:"contract_reference",title:"สัญญาเลขที่",textAlignment:"center",sortable:!1,render:(e,s)=>t("p",{children:(e==null?void 0:e.contract_reference)??"-"})},{accessor:"ins_no",title:"งวดที่",textAlignment:"center",sortable:!1,render:e=>t("p",{children:(e==null?void 0:e.ins_no)??""})},{accessor:"amount",title:"จำนวนเงิน",textAlignment:"center",sortable:!1,render:e=>t("p",{children:x(e==null?void 0:e.amount)})},{accessor:"payment_method",title:"ช่องทางชำระเงิน",textAlignment:"center",sortable:!1,render:(e,s)=>t("p",{children:(e==null?void 0:e.payment_method)??"-"})},{accessor:"payed_at",title:"วันที่ชำระเงิน",textAlignment:"center",sortable:!1,render:(e,s)=>t("p",{children:L(e==null?void 0:e.payed_at)})},{accessor:"payment_reference",title:"เลขที่อ้างอิง",textAlignment:"center",sortable:!1,render:e=>t("p",{children:(e==null?void 0:e.payment_reference)??"-"})},{accessor:"status",title:"สถานะชำระเงิน",textAlignment:"center",sortable:!1,render:(e,s)=>t("div",{className:"flex text-center justify-center font-normal",children:t("div",{className:`badge ${e.payment_status==="complete"?"badge-outline-success":e.payment_status==="pending"?"badge-outline-warning":"badge-outline-danger"}`,children:e.payment_status==="complete"?"สำเร็จ":e.payment_status==="pending"?"รอชำระ":"ไม่สำเร็จ"})})}],highlightOnHover:!0,page:m,totalRecords:K,recordsPerPage:i,recordsPerPageOptions:C,onPageChange:e=>h(e),onRecordsPerPageChange:e=>{h(1),F(e)},paginationText:({from:e,to:s,totalRecords:l})=>`โชว์ ${e} ถึง ${s} ของ ${l} หน้าทั้งหมด`})})]})]})};export{Me as default};

import{an as ye,u as fe,a as Ee,r,s as Se,b as Ce,i as ve,c as p,j as t,f as o,g as m}from"./index-a90aa29c.js";import{c as Te,a as g}from"./object-7405de1d.js";import{S as D}from"./sweetalert2.all-ca2d1030.js";import{_ as x}from"./lodash-f7ec5310.js";import{F as Ie,a as Ne}from"./formik.esm-c4fd04ca.js";import{I as A}from"./InputField-d7971719.js";import{S as M}from"./SelectField-917481a8.js";import{C as y}from"./react-select-creatable.esm-cd844a3e.js";import{t as O}from"./constant-e85f1578.js";import{P as Pe}from"./regex-a1235873.js";import{r as Ue}from"./helpFunction-19eb552d.js";import{b as Re,u as Le,a as De}from"./useAssetMutation-f9664723.js";import{_ as xe}from"./index-f89ea186.js";import{a as Me}from"./useUploadMutation-785f6dd6.js";import{B as Oe}from"./breadcrumbs-b9914bbc.js";import{I as we}from"./IconEdit-bf2b08f0.js";import{P as ke}from"./preLoading-b2445d9d.js";import"./_defineProperty-6dbd93ca.js";import"./_baseIsEqual-06123cd3.js";import"./isObjectLike-b76e75a8.js";import"./isSymbol-15555f2d.js";import"./react-select.esm-b46d9623.js";import"./createSuper-98fcd92d.js";import"./floating-ui.dom-0aeb9e8a.js";const He="admin",us=()=>{const{id:w}=ye(),h=D.mixin(O),f=fe(),E=Ee();r.useEffect(()=>{E(Se("ข้อมูลสินทรัพย์")),E(Ce(["asset","/apps/asset/list"]))},[E]);const N=localStorage.getItem(He),b=N?JSON.parse(N).role:null,n=location.pathname.includes("/view")?!0:b==="shop",k=ve(s=>s.dataStore.assets),[H,j]=r.useState([]),[a,F]=r.useState({}),[V,G]=r.useState([]),[K,B]=r.useState([]),[W,Y]=r.useState([]),[q,z]=r.useState([]),[X,Z]=r.useState([]),[Fe,J]=r.useState([]),[Ve,Q]=r.useState([]),[Ge,$]=r.useState([]),[Ke,ee]=r.useState([]),[u,S]=r.useState([]),se=[{to:"/apps/asset/list",label:"สินทรัพย์"},{label:n?"ข้อมูล":"แก้ไข",isCurrent:!0}];b!="admin"&&b!="business_unit"&&n===!1&&f("/");const{mutate:C}=p(m.shopSearchContains,{onSuccess:s=>{j(s.data.map(e=>({value:e.id,label:e.name})))},onError:s=>{h.fire({icon:"error",title:s.massage,padding:"10px 20px"})}}),{mutate:te,isLoading:ae}=Re({async onSuccess(s){const e=s.data;F(e),(e==null?void 0:e.asset_images.length)>0&&await e.asset_images.forEach(async i=>{S(_=>[..._,{dataURL:i.image_url,name:i.name,id:i.id}])}),L({data:{id_asset_type:e.id_asset_type}}),P({data:{id_asset_type:e.id_asset_type}}),U({data:{id_asset_type:e.id_asset_type}}),v({data:{id_asset_type:e.id_asset_type}}),C({data:{query:e.shop.name}})},onError(s){}}),{mutate:ie,isLoading:ne}=p(m.assetTypeFindAllActive,{onSuccess:s=>{G(s.data.map(e=>({value:e.id,label:e.name})))},onError:()=>{}}),oe=(s,e,i)=>{U({data:{id_asset_type:e==null?void 0:e.value}}),P({data:{id_asset_type:e==null?void 0:e.value}}),v({data:{id_asset_type:e==null?void 0:e.value}}),s.setFieldValue("capacity",""),s.setFieldValue("color",""),s.setFieldValue("model_number","")},re=(s,e,i)=>{L({data:{id_asset_type:e.value}}),s.setFieldValue("name",e.value)},{mutate:P}=p(m.assetColorFindAll,{onSuccess:s=>{const e=s.data.map(i=>({value:i.name,label:i.name}));B(e),J(e)},onError:()=>{}}),{mutate:U}=p(m.assetModelFindAll,{onSuccess:s=>{const e=s.data.map(i=>({value:i.name,label:i.name}));Y(e),Q(e)},onError:()=>{}}),{mutate:v}=p(m.assetCapacityFindAll,{onSuccess:s=>{const e=s.data.map(i=>({value:i.name,label:i.name}));z(e),$(e)},onError:()=>{}}),{mutateAsync:le}=Me({onSuccess:s=>{},onError:s=>{}}),{mutateAsync:de}=p(m.assetImgCreate,{}),{mutateAsync:ce}=Le(),{mutate:R,isLoading:T}=De({onSuccess:async s=>{var e;if(s.code===200||s.statusCode===200){const i=[],_=[];if((e=a.asset_images)==null||e.forEach(l=>{const d=u.find(c=>c.id===l.id);x.isUndefined(d)&&_.push(ce({data:{id:l.id}}))}),u.forEach(l=>{x.isUndefined(l==null?void 0:l.id)&&i.push(le({data:{file:l.file,type:"asset"}}))}),_.length>0&&await Promise.all(_),i.length>0){const l=await Promise.all(i),d=[];l.forEach(c=>{c.code!=="error"?d.push(de({data:{id_asset:s.data.id,name:c.data.file_name,image_url:c.data.file_name,extension:"extension",size:c.data.size}})):D.mixin(O).fire({icon:"error",title:"เพิ่มไฟล์ผิดพลาดกรุณาใช้ไฟล์ที่เป็นรูปเท่านั้น",padding:"10px 20px"})}),d.length>0&&await Promise.all(d)}h.fire({icon:"success",title:"แก้ไขสำเร็จ",padding:"10px 20px"}),f("/apps/asset/list")}else h.fire({icon:"error",title:s.message,padding:"10px 20px"})},onError:s=>{}});r.useEffect(()=>{te({data:{id:w||k.id}}),v({data:{}}),ie({data:{page:1,page_size:-1}})},[]);const{mutate:L}=p(m.assetNameFindAll,{onSuccess:s=>{const e=s.data.map(i=>({value:i.id,label:i.name}));Z(e),ee(e)},onError:()=>{}}),pe=r.useCallback(async s=>{delete s.shop,R({data:{...s,price:Number(s.price)}})},[R,u]),me=async(s,e)=>{const i=await Ue(s);S(i)},_e=()=>{h.fire({icon:"error",title:"รูปภาพเกิน 15 รูป",padding:"10px 20px"})},ue=Te().shape({name:g().required("กรุณาใส่ข้อมูลให้ครบ"),id_asset_type:g().required("กรุณาใส่ข้อมูลให้ครบ"),serial_number:g().required("กรุณาใส่ข้อมูลให้ครบ"),price:g().required("กรุณาใส่ข้อมูลให้ครบ").matches(Pe,"กรุณาใส่ราคาให้ถูกต้อง")}),he=(s,e,i)=>{C({data:{query:e}})},be=()=>{const s=location.pathname.replace("/view","/edit");f(s)};return ne||ae?t("div",{children:"Loading..."}):o("div",{className:"flex flex-col gap-2.5",children:[(T||T)&&t(ke,{}),o("div",{className:"flex items-center justify-between flex-wrap",children:[t(Oe,{items:se}),t("div",{className:"flex",children:n&&b!=="shop"&&o("a",{className:"hover:text-info cursor-pointer btn btn-primary mr-1",onClick:()=>be(),children:[t(we,{className:"w-4.5 h-4.5"}),"   แก้ไข"]})})]}),t("div",{className:"panel px-6 flex-1 py-6",children:t(Ie,{initialValues:a,onSubmit:pe,enableReinitialize:!0,autoComplete:"off",validationSchema:ue,children:s=>o(Ne,{className:"space-y-5 dark:text-white custom-select",children:[t("div",{className:"text-lg font-semibold ltr:sm:text-left rtl:sm:text-right text-center",children:"ข้อมูลสินทรัพย์"}),t("div",{className:"input-flex-row",children:t("div",{className:"w-full",children:t(A,{label:"หมายเลขซีเรียล",name:"serial_number",type:"text",disabled:n})})}),o("div",{className:"input-flex-row",children:[t(M,{id:"id_shop",label:"ร้านค้า",name:"id_shop",options:H,isSearchable:!0,onInputChange:e=>{he(s,e)},handleOnMenuOpen:()=>{C({data:{query:""}})},disabled:n||a.on_contract==!0}),t(M,{id:"id_asset_type",label:"ประเภทสินทรัพย์",name:"id_asset_type",options:V,disabled:n,onChange:e=>{re(s,e)}})]}),o("div",{className:"input-flex-row",children:[o("div",{className:"input-container",children:[o("label",{children:["ชื่อสินทรัพย์ ",t("span",{className:"text-rose-600",children:" * "})]}),t("div",{className:"relative text-white-dark"}),t(y,{id:"name",placeholder:"ชื่อสินทรัพย์",name:"name",isDisabled:n,isClearable:!0,options:X,onChange:e=>{s.setFieldValue("name",e?e.label:""),oe(s,e)},defaultValue:{value:a==null?void 0:a.name,label:a==null?void 0:a.name}})]}),o("div",{className:"input-container",children:[t("label",{children:"หมายเลขรุ่น"}),t("div",{className:"relative text-white-dark",children:t(y,{id:"model_number",placeholder:"หมายเลขรุ่น",name:"model_number",isDisabled:n,isClearable:!0,options:W,onChange:e=>{s.setFieldValue("model_number",e?e.label:"")},defaultValue:{value:a==null?void 0:a.model_number,label:a==null?void 0:a.model_number}})})]})]}),o("div",{className:"input-flex-row",children:[o("div",{className:"input-container",children:[o("label",{children:["ความจุ ",t("span",{className:"text-rose-600",children:" * "})]}),t("div",{className:"relative text-white-dark",children:t(y,{id:"capacity",placeholder:"ความจุ",name:"capacity",isDisabled:n,isClearable:!0,options:q,onChange:e=>{s.setFieldValue("capacity",e?e.label:"")},defaultValue:{value:a==null?void 0:a.capacity,label:a==null?void 0:a.capacity}})})]}),o("div",{className:"input-container",children:[t("label",{children:"สี"}),t("div",{className:"relative text-white-dark",children:t(y,{id:"color",placeholder:"สี",name:"color",isDisabled:n,isClearable:!0,options:K,onChange:e=>{s.setFieldValue("color",e?e.label:"")},defaultValue:{value:a==null?void 0:a.color,label:a==null?void 0:a.color}})})]})]}),o("div",{className:"input-flex-row",children:[t(A,{label:"หมายเลข IMEI",name:"imei",type:"text",maxLength:15,disabled:n,onKeyPress:e=>{/[0-9]/.test(e.key)||e.preventDefault()}}),t(A,{label:"ราคาขาย",require:!0,name:"price",disabled:n,onKeyPress:e=>{/[0-9]/.test(e.key)||e.preventDefault()}})]}),t("div",{className:"input-flex-row",children:t(A,{label:"ข้อสังเกตุ",name:"note",as:"textarea",rows:"4",placeholder:"กรุณาใส่ข้อมูล",className:"form-textarea ltr:rounded-l-none rtl:rounded-r-none resize-none",disabled:n})}),t("div",{className:"input-flex-row",children:o("div",{className:"custom-file-container","data-upload-id":"Image",children:[o("div",{className:"label-container",children:[t("label",{children:" รูปสินทรัพย์ "}),!n&&u.length>0&&t("button",{type:"button",className:"custom-file-container__image-clear",title:"Clear Image",onClick:()=>{S([])},children:"×"})]}),t("label",{className:"custom-file-container__custom-file"+(n?" hidden":"")}),t("input",{type:"file",className:"custom-file-container__custom-file__custom-file-input hidden",accept:"image/*",disabled:n}),t("input",{type:"hidden",name:"MAX_FILE_SIZE",value:"10485760",disabled:n}),t(xe,{multiple:!0,value:u,onChange:me,onError:_e,maxNumber:15,children:({imageList:e,onImageUpload:i,onImageRemoveAll:_,onImageUpdate:l,onImageRemove:d,isDragging:c,dragProps:ge})=>o("div",{className:"upload__image-wrapper",children:[!n&&t("button",{type:"button",className:"custom-file-container__custom-file__custom-file-control custom-btn-select-file",onClick:i,children:"เลือกไฟล์..."})," ",t("div",{className:"grid gap-4 sm:grid-cols-3 grid-cols-1",children:e.map((Ae,I)=>o("div",{className:"custom-file-container__image-preview relative",children:[!n&&t("button",{type:"button",className:"custom-file-container__image-clear bg-dark-light dark:bg-dark dark:text-white-dark rounded-full block w-fit p-1 absolute top-0 right-0 z-10",title:"Clear Image",onClick:()=>{d(I)},children:"×"}),t("div",{className:"custom-file-container__image-preview relative",children:t("img",{src:Ae.dataURL,alt:"img",className:"m-auto"})},I)]},I))})]})})]})}),!n&&o("button",{type:"submit",className:"btn !mt-6 w-full border-0 btn-primary",children:[T&&t("span",{className:"animate-spin border-2 border-white border-l-transparent rounded-full w-5 h-5 ltr:mr-4 rtl:ml-4 inline-block align-middle"}),"แก้ไข"]})]})})})]})};export{us as default};

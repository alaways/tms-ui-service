import{a as ye,u as be,ar as ve,r as n,c as T,g as S,s as Ne,f as s,j as e,L as xe,t as N,F as W,m as Ae}from"./index-a90aa29c.js";import{Q as Ee}from"./index-2f30bf27.js";import{b as z}from"./formatDate-4e046265.js";import{T as X}from"./tippy-react.esm-150a8dd6.js";import{F as Te,a as Se}from"./formik.esm-c4fd04ca.js";import{I as Q}from"./IconX-54a3093e.js";import{_ as Ce}from"./index-f89ea186.js";import{r as Ie}from"./helpFunction-19eb552d.js";import{t as we}from"./constant-e85f1578.js";import{S as h}from"./sweetalert2.all-ca2d1030.js";import{a as Pe}from"./useUploadMutation-785f6dd6.js";import{P as Ue}from"./preLoading-b2445d9d.js";import{s as ke}from"./showNotification-b9615e49.js";import{q as _,_ as x}from"./transition-d4ca4cfa.js";import"./floating-ui.dom-0aeb9e8a.js";import"./keyboard-f171a3e5.js";import"./use-is-mounted-22b05dcc.js";import"./bugs-a60d55c3.js";const Re="admin",tt=()=>{var j,H,F,B,V,G,Y;const C=ye(),p=be(),q=ve(),[I,y]=n.useState(!1),[w,P]=n.useState(!1),{contractData:i}=q.state||{},U=localStorage.getItem(Re),k=U?JSON.parse(U).role:null,[Oe,R]=n.useState(!0),[O,Z]=n.useState([]),[o,J]=n.useState(null),[a,$]=n.useState({}),[g,ee]=n.useState({}),[A,te]=n.useState({}),[m,se]=n.useState({id_payment:0,payment_slip:[]}),[b,M]=n.useState([]),v=h.mixin(we),{mutate:D,isLoading:L}=T(S.customContract+i.id,{onSuccess:t=>{const{installments:r,asset:l,...c}=t.data;(c==null?void 0:c.on_payment_process)=="close_contract"&&p("/apps/customer-payment/invoice-cc/"+c.id),Z(r),te(l),ee(c);const d=t.data.installments.find(E=>E.payed_at===null);J(d||null),R(!1)},onError:()=>{R(!1)}});n.useEffect(()=>{k!=="customer"&&p("/")},[k,p]),n.useEffect(()=>{C(Ne("ยอดที่ต้องชำระ"))},[C]),n.useEffect(()=>{i&&D({})},[D,i]);const ae=(t,r)=>{switch(t){case"complete":return"ชำระแล้ว";default:return r?"ค้างชำระ":"ยังไม่ครบกำหนด"}},oe=(t,r)=>{switch(t){case"complete":return"btn-success";default:return r?"btn-danger":"btn-dark"}},re=t=>{p("/apps/customer-payment/invoice",{state:{installmentLast:o==null?void 0:o.id,contractID:i.id,ins_no:t,history:!0}})},ne=async t=>{console.log("image,change",t);const r=await Ie(t);console.log("resizedImages",r),M(r)},ie=()=>{v.fire({icon:"error",title:"รูปภาพเกิน 10 รูป",padding:"10px 20px"})},ce=n.useCallback(async t=>{console.log(t==null?void 0:t.id_payment),t!=null&&t.id_payment&&await me(t==null?void 0:t.id_payment)},[b]),{mutateAsync:le,isLoading:de}=Pe({onSuccess:t=>{},onError:t=>{}}),{mutateAsync:pe}=T(S.contractAddSlip),me=async t=>{const r=[];console.log("id",t),console.log("images",b),b.forEach(c=>{r.push(le({data:{file:c.file,type:"payment"}}))});const l=[];r.length>0&&(await Promise.all(r)).forEach(d=>{(d==null?void 0:d.code)!=="error"?l.push(pe({data:{id_payment:t,image_url:d.data.file_name}})):v.fire({icon:"error",title:"เพิ่มไฟล์ผิดพลาดกรุณาใช้ไฟล์ที่เป็นรูปเท่านั้น",padding:"10px 20px"})}),l.length>0&&(await Promise.all(l),h.fire({icon:"success",title:"ชำระเงินสำเร็จ",padding:"10px 20px"}).then(()=>{window.location.reload()}))},ue=t=>{se({...m,payment_slip:(t==null?void 0:t.payment_slip)??[],id_payment:t==null?void 0:t.payment.id}),console.log("setFormData",t==null?void 0:t.payment.id),P(!0)},{mutate:he,isLoading:_e}=T(S.customerCancelQrcode,{onSuccess:async t=>{t.statusCode===400||t.code===400?ke(t.message,"error"):(v.fire({icon:"success",title:"สำเร็จ",padding:"10px 20px"}),setTimeout(()=>{window.location.reload()},500))},onError:t=>{v.fire({icon:"error",title:t.message,padding:"10px 20px"})}}),ge=async()=>{h.fire({title:"ยืนยันการยกเลิกการชำระเงิน",text:"คุณต้องการยกเลิกชำระเงินใช่หรือไม่?",icon:"warning",showCancelButton:!0,confirmButtonColor:N.color.themePrimary,cancelButtonColor:"#d33",confirmButtonText:"ยืนยัน",cancelButtonText:"ยกเลิก",reverseButtons:!0}).then(t=>{t.isConfirmed&&he({data:{id_payment:o.payment.uuid}})})},fe=async()=>{g.on_payment_process=="close_contract"?p("/apps/customer-payment/invoice-cc/"+i.id):h.fire({title:"คุณต้องการปิดสัญญาใช่หรือไม่",text:"",showCancelButton:!0,confirmButtonText:"ยืนยัน",cancelButtonText:"ยกเลิก",reverseButtons:!0,didOpen:()=>{const t=h.getConfirmButton(),r=h.getCancelButton();t.style.backgroundColor=N.color.themePrimary,t.style.color="white",r.style.backgroundColor="#2196F3",r.style.color="white"}}).then(t=>{t.isConfirmed&&p("/apps/customer-payment/invoice-cc/"+i.id)})};return s("div",{children:[(de||L||_e)&&e(Ue,{}),s("div",{className:"flex justify-between",children:[s("ul",{className:"flex space-x-2 rtl:space-x-reverse",children:[e("li",{children:e(xe,{to:"/apps/customer-payment/list",className:"text-primary hover:underline",children:"หน้าหลัก"})}),e("li",{className:"before:content-['/'] ltr:before:mr-2 rtl:before:ml-2",children:s("span",{children:["เลขที่สัญญา ",i.reference]})})]}),((j=N)==null?void 0:j.features.customer_close_contract)&&g.on_payment_process===""&&e("div",{children:s("button",{type:"button",className:"flex-0 btn btn-sm btn-outline-danger",onClick:()=>fe(),disabled:g.on_payment_process==="pay_installment",children:["ปิดสัญญา ",g.on_payment_process==="close_contract"?"(กำลังชำระเงิน)":""]})})]}),e("div",{className:"pt-5",children:s("div",{className:"panel px-0 border-white-light dark:border-[#1b2e4b] pt-0",children:[((H=N.features)==null?void 0:H.customer_close_contract)&&g.on_payment_process==="pay_installment"&&e("div",{className:"w-full h-auto text-center text-warning bg-warning-light dark:bg-warning-dark-light rounded-md mb-5",children:s("div",{className:"flex justify-between items-center p-5",children:[s("div",{className:"text-left",children:["ขณะนี้อยู่ระหว่างการดำเนินการชำระเงิน กรุณาชำระเงิน หรือกดยกเลิกหากท่านไม่ประสงค์จะดำเนินการต่อ ",">"]}),e("button",{type:"button",className:"btn btn-sm btn-outline-danger",onClick:()=>ge(),children:"ยกเลิก"})]})}),s("div",{className:"flex items-center justify-between mb-10",children:[s("h5",{className:"font-semibold text-lg dark:text-white-light pl-4",children:["เลขที่สัญญา ",i.reference]}),s("p",{className:"mr-4",children:["งวดที่ ",o==null?void 0:o.ins_no," / ",O.length]})]}),!(o!=null&&o.payed_at)&&s(W,{children:[e("div",{className:"flex items-center justify-center my-5",children:e("h2",{className:"text-xl",children:"ยอดที่ต้องชำระ"})}),e("div",{className:"flex items-center justify-center",children:s("p",{className:"text-5xl",children:[L?0:((o==null?void 0:o.amount)+(o==null?void 0:o.penalty_fee)+(o==null?void 0:o.unlock_fee)).toLocaleString()," บาท"]})}),e("div",{className:"flex items-center justify-center my-5",children:e("button",{type:"button",className:"btn btn-secondary btn-lg w-36 border-0 bg-gradient-to-r from-[#3d38e1] to-[#1e9afe]",onClick:()=>o&&re(o),children:"ชำระเงิน"})})]}),e("div",{className:"datatables pagination-padding",children:e(Ee,{className:"whitespace-nowrap table-hover invoice-table",records:O,highlightOnHover:!0,columns:[{accessor:"id",title:"ลำดับ",sortable:!1,render:(t,r)=>e("div",{children:r+1})},{accessor:"amount",title:"ผ่อนงวดละ",sortable:!1,render:({amount:t})=>e("div",{className:"flex items-center font-normal",children:e("div",{children:t==null?void 0:t.toLocaleString()})})},{accessor:"due_at",title:"วันที่ครบกำหนด",sortable:!1,render:({due_at:t})=>e("div",{className:"flex items-center font-normal",children:e("div",{children:z(t)})})},{accessor:"status",title:"สถานะ",sortable:!1,render:({status:t,is_due:r})=>e("div",{className:"flex items-center font-normal",children:e("span",{className:`badge ${oe(t,r)}`,children:ae(t,r)})})},{accessor:"payment",title:"ยอดชำระ",sortable:!1,render:({ins_no:t,payment:r})=>e("div",{className:"flex items-center font-normal",children:(o==null?void 0:o.ins_no)!==void 0&&t<=(o==null?void 0:o.ins_no)?e("div",{children:(r==null?void 0:r.amount)!=null?r.amount:"-"}):e("div",{children:"-"})})},{accessor:"payed_at",title:"วันที่ชำระ",sortable:!1,render:({payed_at:t})=>e("div",{className:"flex items-center font-normal",children:e("div",{children:t?z(t):"-"})})},{accessor:"action",title:"Actions",sortable:!1,textAlignment:"center",render:t=>e("div",{className:"flex gap-4 items-center w-max mx-auto",children:t.status=="complete"&&s(W,{children:[e(X,{theme:"Primary",children:e("a",{className:"flex hover:text-info cursor-pointer",onClick:()=>{$(t),y(!0)},children:"รายละเอียด"})}),e(X,{theme:"Primary",children:e("a",{className:"flex hover:text-info cursor-pointer",onClick:()=>ue(t),children:"หลักฐานการโอนเงิน"})})]})})}]})})]})}),e(_,{appear:!0,show:I,as:n.Fragment,children:s(x,{as:"div",open:I,onClose:()=>y(!1),className:"relative z-[51]",children:[e(_.Child,{as:n.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e("div",{className:"fixed inset-0 bg-[black]/60"})}),e("div",{className:"fixed inset-0 overflow-y-auto",children:e("div",{className:"flex min-h-full items-center justify-center px-4 py-8",children:e(_.Child,{as:n.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:s(x.Panel,{className:"panel border-0 p-0 rounded-lg overflow-hidden w-full max-w-lg text-black dark:text-white-dark",children:[e("button",{type:"button",onClick:()=>{y(!1)},className:"absolute top-4 ltr:right-4 rtl:left-4 text-gray-400 hover:text-gray-800 dark:hover:text-gray-600 outline-none",children:e(Q,{})}),s("div",{className:"text-lg font-medium bg-[#fbfbfb] dark:bg-[#121c2c] ltr:pl-5 rtl:pr-5 py-3 ltr:pr-[50px] rtl:pl-[50px]",children:["เลขที่สัญญา : ",i.reference]}),s("div",{className:"p-8",children:[s("div",{className:"grid grid-cols-2 content-center",children:[e("div",{className:"h-auto p-2 w-auto",children:" ชื่อสินทรัพย์ "}),s("div",{className:"h-auto p-2 w-auto text-right",children:[" ",A==null?void 0:A.name]})]}),s("div",{className:"grid grid-cols-2 content-center",children:[e("div",{className:"h-auto p-2 w-auto",children:" งวดที่ "}),s("div",{className:"h-auto p-2 w-auto text-right",children:[" ",a==null?void 0:a.ins_no]})]}),s("div",{className:"grid grid-cols-2 content-center",children:[e("div",{className:"h-auto p-2 w-auto",children:" วันที่ชำระ "}),s("div",{className:"h-auto p-2 w-auto text-right",children:[" ",a!=null&&a.payed_at?Ae(a==null?void 0:a.payed_at).format("DD/MM/YYYY"):"-"," "]})]}),s("div",{className:"grid grid-cols-2 content-center",children:[e("div",{className:"h-auto p-2 w-auto",children:" ค่างวด "}),s("div",{className:"h-auto p-2 w-auto text-right",children:[" ",(F=a==null?void 0:a.amount)==null?void 0:F.toLocaleString("en-US")," บาท"]})]}),(a==null?void 0:a.penalty_fee)>0&&s("div",{className:"grid grid-cols-2 content-center",children:[e("div",{className:"h-auto p-2 w-auto",children:" ค่าดำเนินการล่าช้า "}),s("div",{className:"h-auto p-2 w-auto text-right",children:[" ",(B=a==null?void 0:a.penalty_fee)==null?void 0:B.toLocaleString("en-US")," บาท"]})]}),(a==null?void 0:a.unlock_fee)>0&&s("div",{className:"grid grid-cols-2 content-center",children:[e("div",{className:"h-auto p-2 w-auto",children:" ค่าปลดล็อค "}),s("div",{className:"h-auto p-2 w-auto text-right",children:[" ",(V=a==null?void 0:a.unlock_fee)==null?void 0:V.toLocaleString("en-US")," บาท"]})]}),(a==null?void 0:a.discount)>0&&s("div",{className:"grid grid-cols-2 content-center",children:[e("div",{className:"h-auto p-2 w-auto",children:" ส่วนลด "}),s("div",{className:"h-auto p-2 w-auto text-right",children:[" ",(G=a==null?void 0:a.discount)==null?void 0:G.toLocaleString("en-US")," บาท"]})]}),s("div",{className:"grid grid-cols-2 content-center",children:[e("div",{className:"h-auto p-2 w-auto",children:" รวมเป็นเงิน "}),s("div",{className:"h-auto p-2 w-auto text-right",children:[(((Y=a==null?void 0:a.payment)==null?void 0:Y.amount)||0).toLocaleString("en-US")," บาท"]})]})]})]})})})})]})}),e(_,{appear:!0,show:w,as:n.Fragment,children:s(x,{as:"div",open:w,onClose:()=>y(!1),className:"relative z-[51]",children:[e(_.Child,{as:n.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:e("div",{className:"fixed inset-0 bg-[black]/60"})}),e("div",{className:"fixed inset-0 overflow-y-auto",children:e("div",{className:"flex min-h-full items-center justify-center px-4 py-8",children:e(_.Child,{as:n.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:s(x.Panel,{className:"panel border-0 p-0 rounded-lg overflow-hidden w-full max-w-lg text-black dark:text-white-dark",style:{maxWidth:"800px",width:"90%"},children:[e("button",{type:"button",onClick:()=>{M([]),P(!1)},className:"absolute top-4 ltr:right-4 rtl:left-4 text-gray-400 hover:text-gray-800 dark:hover:text-gray-600 outline-none",children:e(Q,{})}),e("div",{className:"text-lg font-medium bg-[#fbfbfb] dark:bg-[#121c2c] ltr:pl-5 rtl:pr-5 py-3 ltr:pr-[50px] rtl:pl-[50px]",children:"เพิ่มหลักฐานการชำระเงิน"}),e(Te,{initialValues:m,onSubmit:t=>ce(t),enableReinitialize:!0,autoComplete:"off",onChange:()=>console.log(""),children:t=>e(Se,{onSubmit:t.handleSubmit,className:"space-y-5 dark:text-white custom-select",children:e("div",{className:"flex flex-row pt-4 pb-4 gap-4",children:e("div",{className:"upload-container w-full",style:{paddingLeft:"10px",paddingRight:"10px"},children:s("div",{className:"custom-file-container","data-upload-id":"firstImage",children:[e("input",{type:"hidden",name:"id_payment",value:m.id_payment,readOnly:!0}),e("input",{type:"file",className:"custom-file-container__custom-file__custom-file-input hidden",accept:"image/*"}),e("input",{type:"hidden",name:"MAX_FILE_SIZE1",value:"10485760"}),e("div",{children:e(Ce,{multiple:!0,value:b,onChange:ne,onError:ie,maxNumber:10,children:({imageList:r,onImageUpload:l,onImageRemoveAll:c,onImageUpdate:d,onImageRemove:E,isDragging:Me,dragProps:De})=>{var K;return s("div",{className:"upload__image-wrapper",children:[s("div",{className:"flex space-x-4",children:[e("button",{className:"btn btn-primary",onClick:l,type:"button",children:"เลือกไฟล์..."}),e("button",{type:"submit",className:"btn btn-success",children:"บันทึกข้อมูล"})]}),e("div",{className:"grid gap-4 sm:grid-cols-3 grid-cols-1 pt-[70px]",children:(K=m==null?void 0:m.payment_slip)==null?void 0:K.map((u,f)=>e("div",{className:"custom-file-container__image-preview relative",children:e("img",{src:u.image_url,alt:"img",className:"m-auto pointer",onClick:()=>{}})},f))}),e("div",{className:"grid gap-4 sm:grid-cols-3 grid-cols-1",children:r.map((u,f)=>s("div",{className:"custom-file-container__image-preview relative",children:[(u==null?void 0:u.id)===void 0&&e("button",{type:"button",className:"custom-file-container__image-clear bg-dark-light dark:bg-dark dark:text-white-dark rounded-full block w-fit p-1 absolute top-0 left-0 z-10",title:"Clear Image",onClick:()=>{E(f)},children:"×"}),e("div",{className:"custom-file-container__image-preview relative",children:e("img",{src:u.dataURL,alt:"img",className:"m-auto pointer",onClick:()=>{}})},f)]},f))})]})}})})]})})})})})]})})})})]})})]})};export{tt as default};

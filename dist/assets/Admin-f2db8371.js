import{a as Te,u as Se,r as a,c as A,aC as ve,s as Ie,b as Pe,f as r,j as s,F as Re,g as b}from"./index-a90aa29c.js";import{u as T,w as Ce}from"./xlsx-9a117414.js";import{t as Ue,l as Ne,n as De,o as F}from"./constant-e85f1578.js";import{n as y}from"./formatNumeric-862380d6.js";import{a as D,c as xe,t as Oe}from"./formatDate-4e046265.js";import{F as Me,a as ke}from"./formik.esm-c4fd04ca.js";import{Q as Le}from"./index-2f30bf27.js";import{S as He}from"./sweetalert2.all-ca2d1030.js";import{I as je}from"./InputField-d7971719.js";import{I as we}from"./IconX-54a3093e.js";import{I as Fe}from"./IconChecks-e4ba7579.js";import{P as Ve}from"./preLoading-b2445d9d.js";import{S}from"./SelectField-917481a8.js";import{P as V}from"./config-8de56c22.js";/* empty css              */import{D as Ge}from"./DateRangeAntd-92e3cf4d.js";import{I as Ke}from"./IconEye-eb8ead5b.js";import{I as Be}from"./IconRefresh-fed8c080.js";import{q as x,_ as G}from"./transition-d4ca4cfa.js";import"./floating-ui.dom-0aeb9e8a.js";import"./react-select.esm-b46d9623.js";import"./createSuper-98fcd92d.js";import"./lodash-f7ec5310.js";import"./buddhistEra-a2d9672b.js";import"./index-8d8bdff8.js";import"./keyboard-f171a3e5.js";import"./use-is-mounted-22b05dcc.js";import"./bugs-a60d55c3.js";const We="admin",g=He.mixin(Ue),Ye="dev",Et=()=>{const v=Te(),K=Se(),B="https://dev-tms-admin.gsrental.cn:7443/api/v1",O=localStorage.getItem(We),m=O?JSON.parse(O):null,W=m?m==null?void 0:m.role:null,Y=m?m==null?void 0:m.access_token:null,q={start_at:"",end_at:"",id_business_unit:null,query:"",status:"",payment_method:"",status_code:""},[c,M]=a.useState(q),[k,I]=a.useState(!1),[X,z]=a.useState([]),[L,P]=a.useState(!1),[l,H]=a.useState([]),[f,E]=a.useState(1);a.useState(1);const[u,Z]=a.useState(V[0]),[Q,$]=a.useState(0),[n,R]=a.useState(),[J,j]=a.useState([]),[_,C]=a.useState([]),ee=async e=>{const t=new Headers;t.append("Content-Type","application/json"),t.append("Authorization",`Bearer ${Y}`);const i=JSON.stringify({...e,page:1,page_size:5e4}),p={method:"POST",headers:t,body:i,redirect:"follow"};return fetch(B+b.paymentFindAll,p).then(d=>d.json()).then(d=>d.data).catch(d=>[])},{mutate:te}=A(b.contractFilter,{onSuccess:e=>{j(e.data.business_unit.map(t=>({value:t.id,label:t.name}))),z(e.data.status.map(t=>({value:t.status_code,label:t.name})))},onError:()=>{console.error("Failed to fetch asset type data")}});a.useEffect(()=>{te({data:{is_approved:!0}})},[]);const se=async(e,t)=>{if(!k){I(!0);const i={start_at:t.date_at?t.date_at[0]:null,end_at:t.date_at?t.date_at[1]:null,id_business_unit:t.id_business_unit,query:t.query,status:t.status,payment_method:t.payment_method,status_code:t.status_code};(i.start_at===null||i.end_at===null)&&(I(!1),g.fire({icon:"warning",title:"กรุณาเลือกข้อมูลวันที่ให้ครบเพื่อดาวน์โหลด",padding:"10px 20px"}));const p=await ee(i);p.list.reduce((o,N)=>N.amount+o,0);const d=T.json_to_sheet(p.list.map((o,N)=>({no:N+1,contract_id:o.contract_reference,business_unit_name:o.business_unit_name,customer_name:o.customer_name,ins_no:o.ins_no,amount:o.amount,status:o.status==="complete"?"สำเร็จ":"ค้างชำระ",channel:o.channel,payed_at:o.payed_at,payment_method:o.payment_method,reference:o.reference,tracking_fee:o.tracking_fee,unlock_fee:o.unlock_fee,penalty_fee:o.penalty_fee,discount:o.discount,total:o.total})),{header:F.map(o=>o.id)}),w=T.book_new();T.book_append_sheet(w,d,"Sheet1");const Ae=F.map(o=>o.displayName);T.sheet_add_aoa(d,[Ae],{origin:"A1"});const ge=Ce(w,{bookType:"xlsx",type:"array"}),fe=new Blob([ge],{type:"application/octet-stream"}),h=document.createElement("a"),Ee=URL.createObjectURL(fe);h.setAttribute("href",Ee),h.setAttribute("download",e+".xlsx"),h.style.visibility="hidden",document.body.appendChild(h),h.click(),document.body.removeChild(h),I(!1)}},ne=(e=null)=>{var t;if((e==null?void 0:e.payment_method)=="tqr"){const i={billerId:e==null?void 0:e.billerID,transDate:xe(e==null?void 0:e.created_at),amount:(t=e==null?void 0:e.total)==null?void 0:t.toFixed(2),reference1:e==null?void 0:e.reference,reference2:`${e==null?void 0:e.contract_reference}T${e==null?void 0:e.ins_no}`};ie({data:i})}else re({data:{refno:e.reference}});C(e),P(!0)},{mutate:ae}=A(b.businessUnitFindAll,{onSuccess:e=>{j(e.data.list.map(t=>({value:t.id,label:t.name})))},onError:()=>{console.error("Failed to fetch bu data")}}),{mutate:U,isLoading:oe}=A(b.paymentFindAll,{onSuccess:e=>{H(e.data.list),$(e.data.total)},onError:()=>{console.error("Failed to fetch asset type data")}}),{mutate:re}=A(b.inquiryPayment,{onSuccess:e=>{var t,i,p;(e.statusCode===200||e.code===200)&&R({Total:(t=e==null?void 0:e.data)==null?void 0:t.Total,StatusName:(i=e==null?void 0:e.data)==null?void 0:i.StatusName,OrderDateTime:D((p=e==null?void 0:e.data)==null?void 0:p.OrderDateTime)})},onError:()=>{}}),{mutate:ie}=ve("/tqr/inquiry",{onSuccess:e=>{var t,i,p,d;(t=e==null?void 0:e.data)!=null&&t.amount&&R({Total:(i=e==null?void 0:e.data)==null?void 0:i.amount,StatusName:"Paid",OrderDateTime:`${Oe((p=e==null?void 0:e.data)==null?void 0:p.transDate)} ${(d=e==null?void 0:e.data)==null?void 0:d.transTime}`})},onError:()=>{}}),le=(e=null)=>{open("/apps/contract/payment/"+e.contract_id+"/"+e.contract_uuid+"/"+e.id_installment,"_blank")},ce=e=>{open("/apps/contract/"+e.contract_id+"/"+e.contract_uuid,"_blank")};a.useEffect(()=>{v(Ie("การชำระเงิน")),v(Pe(["finance","/apps/finance/payment-history"])),ae({data:{page:1,page_size:-1}})},[v,W,K]);const pe=e=>{if(e.id_business_unit===null)g.fire({icon:"warning",title:"กรุณาเลือกหน่วยธุรกิจเพื่อค้นหา",padding:"10px 20px"});else{E(1);const t={start_at:e.date_at?e.date_at[0]:null,end_at:e.date_at?e.date_at[1]:null,id_business_unit:e.id_business_unit,query:e.query,status:e.status,payment_method:e.payment_method,status_code:e.status_code};M(t),U({data:{...t,page:1,page_size:u}})}};a.useEffect(()=>{c!=null&&c.id_business_unit&&U({data:{...c,page:1,page_size:u}})},[u]),a.useEffect(()=>{c!=null&&c.id_business_unit&&U({data:{...c,id_business_unit:c==null?void 0:c.id_business_unit,page:f,page_size:u}})},[f]);const{mutate:de}=A(b.paymentResubmit,{onSuccess:e=>{e.statusCode===200||e.code===200?g.fire({icon:"success",title:"ปรับปรุงข้อมูลสำเร็จ",padding:"10px 20px"}):g.fire({icon:"error",title:e.message,padding:"10px 20px"})},onError:e=>{g.fire({icon:"error",title:e.massage,padding:"10px 20px"})}}),_e=a.useMemo(()=>l.reduce((e,t)=>e+t.amount,0),[l]),me=a.useMemo(()=>l.reduce((e,t)=>e+t.total,0),[l]),ue=a.useMemo(()=>l.reduce((e,t)=>e+t.penalty_fee,0),[l]),he=a.useMemo(()=>l.reduce((e,t)=>e+t.tracking_fee,0),[l]),be=a.useMemo(()=>l.reduce((e,t)=>e+t.unlock_fee,0),[l]),ye=a.useMemo(()=>l.reduce((e,t)=>e+t.discount,0),[l]);return r("div",{className:"panel px-0 border-white-light dark:border-[#1b2e4b]",children:[(oe||k)&&s(Ve,{}),r("div",{className:"invoice-table",children:[s("div",{className:"ml-7 my-5 text-lg font-semibold ltr:sm:text-left rtl:sm:text-right text-center flex flex-row justify-between",children:"การชำระเงิน"}),s("div",{className:"mb-4.5 px-5 md:items-center md:flex-row flex-col gap-5",children:s(Me,{initialValues:c,onSubmit:pe,onReset:()=>{M({start_at:"",end_at:"",id_business_unit:null,query:"",status:"",payment_method:"",status_code:""}),E(1),H([])},children:({setFieldValue:e,handleReset:t,values:i})=>r(ke,{className:"flex flex-col flex-auto gap-2",children:[r("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5",children:[s("div",{className:"flex-1 z-10",children:s(S,{id:"id_business_unit",label:"หน่วยธุรกิจ",name:"id_business_unit",placeholder:"เลือกหน่วยธุรกิจ",options:J})}),s("div",{className:"flex-1 z-10",children:s(S,{id:"status",label:"สถานะการชำระเงิน",name:"status",placeholder:"กรุณาเลือก",options:Ne})}),s("div",{className:"flex-1 z-10",children:s(S,{id:"payment_method",label:"ช่องทางชำระเงิน",name:"payment_method",placeholder:"กรุณาเลือก",options:De})})]}),r("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5",children:[s(S,{id:"status_code",label:"สถานะดำเนินการ",name:"status_code",placeholder:"เลือก สถานะ",options:X,isSearchable:!0}),s(Ge,{label:"วันที่ชำระ",name:"date_at"}),s(je,{label:"ค้นหา",placeholder:"ค้นหา",name:"query",type:"text"}),s("button",{type:"submit",className:"btn btn-primary gap-2 mt-5",children:"ค้นหา"}),s("button",{type:"reset",className:"btn btn-info gap-2 mt-5",onClick:()=>{t()},children:"ล้างค่า"}),s("div",{className:"flex flex-col pt-5",children:s("button",{type:"button",className:"btn btn-success gap-2 w-full h-[40px]",onClick:()=>se(`payment_history_${new Date().toLocaleString()}`,i),children:"Export"})})]})]})})}),s("div",{className:"datatables pagination-padding",children:l.length===0?s("div",{className:"text-center text-gray-500",children:"ไม่พบข้อมูล"}):s(Le,{className:"whitespace-nowrap table-hover invoice-table",records:[...l.map((e,t)=>({...e,key:t})),{id:"total",amount:_e,total:me,penalty_fee:ue,tracking_fee:he,unlock_fee:be,discount:ye,isTotalRow:!0,ins_no:"ผลรวม"}],columns:[{accessor:"id",title:"ลำดับ",textAlignment:"center",sortable:!1,render:(e,t)=>e.isTotalRow?null:s("div",{children:t+1+(f-1)*u})},{accessor:"credit_code",title:"สถานะดำเนินการ",textAlignment:"left",sortable:!1},{accessor:"reference",title:"เลขที่อ้างอิง",textAlignment:"left",sortable:!1},{accessor:"contract_reference",title:"เลขที่สัญญา",textAlignment:"center",sortable:!0,render:e=>e.isTotalRow?null:s("div",{className:"pointer active",onClick:()=>ce(e),children:e.contract_reference})},{accessor:"business_unit_name",title:"หน่วยธุรกิจ",textAlignment:"left",sortable:!1,render:e=>s("div",{className:"pointer",children:e==null?void 0:e.business_unit_name})},{accessor:"customer_name",title:"ชื่อลูกค้า",textAlignment:"left",sortable:!1},{accessor:"payment_method",title:"ช่องทางชำระเงิน",textAlignment:"center",sortable:!1},{accessor:"ins_no",title:"ชำระงวดที่",textAlignment:"center",sortable:!1},{accessor:"amount",title:"ค่างวด",textAlignment:"right",sortable:!1,render:({amount:e,isTotalRow:t})=>s("div",{className:"flex items-center justify-end font-normal",children:r("div",{className:t?"font-bold":"",children:[y(e)," ",t&&"บาท"]})})},{accessor:"penalty_fee",title:"ค่าดำเนินการล่าช้า",textAlignment:"right",sortable:!1,render:({penalty_fee:e,isTotalRow:t})=>s("div",{className:"flex items-center justify-end font-normal",children:r("div",{className:t?"font-bold":"",children:[y(e)," ",t&&"บาท"]})})},{accessor:"tracking_fee",title:"ค่าติดตาม",textAlignment:"right",sortable:!1,render:({tracking_fee:e,isTotalRow:t})=>s("div",{className:"flex items-center justify-end font-normal",children:r("div",{className:t?"font-bold":"",children:[y(e)," ",t&&"บาท"]})})},{accessor:"unlock_fee",title:"ค่าปลดล็อค",textAlignment:"right",sortable:!1,render:({unlock_fee:e,isTotalRow:t})=>s("div",{className:"flex items-center justify-end font-normal",children:r("div",{className:t?"font-bold":"",children:[y(e)," ",t&&"บาท"]})})},{accessor:"discount",title:"ส่วนลด",textAlignment:"right",sortable:!1,render:({discount:e,isTotalRow:t})=>s("div",{className:"flex items-center justify-end font-normal",children:r("div",{className:t?"font-bold":"",children:[y(e)," ",t&&"บาท"]})})},{accessor:"total",title:"ยอดชำระ",textAlignment:"right",sortable:!1,render:({total:e,isTotalRow:t})=>s("div",{className:"flex items-center justify-end font-normal",children:r("div",{className:t?"font-bold":"",children:[y(e)," ",t&&"บาท"]})})},{accessor:"status",title:"สถานะการชำระเงิน",textAlignment:"center",sortable:!1,render:({status:e,isTotalRow:t})=>t?null:s("div",{className:"flex text-center justify-center font-normal",children:s("div",{className:`badge ${e==="complete"?"badge-outline-success":e==="pending"?"badge-outline-warning":"badge-outline-danger"}`,children:e==="complete"?"สำเร็จ":e==="pending"?"รอชำระ":"ไม่สำเร็จ"})})},{accessor:"channel",title:"ช่องทาง",textAlignment:"center",sortable:!1,render:(e,t)=>s("p",{children:(e==null?void 0:e.channel)??"-"})},{accessor:"payed_at",title:"วันที่ชำระ",textAlignment:"right",sortable:!1,render:({payed_at:e,isTotalRow:t})=>t?null:s("div",{className:"flex items-center justify-end font-normal",children:s("div",{children:e!=="-"&&e!==null&&e!==""?D(e):"-"})})},{accessor:"created_at",title:"วันที่ดำเนินการ",textAlignment:"right",sortable:!1,render:({created_at:e,isTotalRow:t})=>t?null:s("div",{className:"flex items-center justify-end font-normal",children:s("div",{children:e!=="-"&&e!==null&&e!==""?D(e):"-"})})},{accessor:"action",title:"Actions",sortable:!1,textAlignment:"center",render:e=>e.isTotalRow?null:s("div",{className:"flex gap-4 items-center w-max mx-auto",children:r(Re,{children:[(e==null?void 0:e.payment_method)!="cash"&&s("div",{className:"bg-[#E5E4E2] w-8 h-8 rounded-full flex items-center justify-center text-white",children:s("a",{className:"flex cursor-pointer active",onClick:()=>ne(e),children:s(Be,{className:"w-4.5 h-4.5"})})}),(e==null?void 0:e.status)==="complete"&&s("div",{className:"bg-[#E5E4E2] w-8 h-8 rounded-full flex items-center justify-center text-white",children:s("a",{className:"flex cursor-pointer active",onClick:()=>le(e),children:s(Ke,{className:"w-4.5 h-4.5"})})})]})})}],page:f,totalRecords:Q,recordsPerPage:u,recordsPerPageOptions:V,onPageChange:e=>E(e),onRecordsPerPageChange:e=>{E(1),Z(e)},paginationText:({from:e,to:t,totalRecords:i})=>`โชว์ ${e} ถึง ${t} ของ ${i} หน้าทั้งหมด`})}),s(x,{appear:!0,show:L,as:a.Fragment,children:r(G,{as:"div",open:L,onClose:()=>{P(!1),C([])},className:"relative z-[51]",children:[s(x.Child,{as:a.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0",enterTo:"opacity-100",leave:"ease-in duration-200",leaveFrom:"opacity-100",leaveTo:"opacity-0",children:s("div",{className:"fixed inset-0 bg-[black]/60"})}),s("div",{className:"fixed inset-0 overflow-y-auto",children:s("div",{className:"flex min-h-full items-center justify-center px-4 py-8",children:s(x.Child,{as:a.Fragment,enter:"ease-out duration-300",enterFrom:"opacity-0 scale-95",enterTo:"opacity-100 scale-100",leave:"ease-in duration-200",leaveFrom:"opacity-100 scale-100",leaveTo:"opacity-0 scale-95",children:r(G.Panel,{className:"panel border-0 p-0 rounded-lg overflow-hidden w-full max-w-lg text-black dark:text-white-dark",children:[s("button",{type:"button",onClick:()=>{R({}),P(!1),C([])},className:"absolute top-4 ltr:right-4 rtl:left-4 text-gray-400 hover:text-gray-800 dark:hover:text-gray-600 outline-none",children:s(we,{})}),s("div",{className:"text-lg font-medium bg-[#fbfbfb] dark:bg-[#121c2c] ltr:pl-5 rtl:pr-5 py-3 ltr:pr-[50px] rtl:pl-[50px]",children:"สถานะการชำระเงิน"}),r("div",{className:"p-5",children:[s("div",{className:"flex items-center justify-center",children:s("span",{className:"flex items-center justify-center w-16 h-16 rounded-full bg-[#d9f2e6] dark:bg-white/10",children:s(Fe,{className:"w-10 h-10 "})})}),r("div",{className:"p-5",children:[r("div",{className:"mb-5 space-y-1",children:[r("div",{className:"flex items-center justify-between",children:[s("p",{className:"text-[#515365] font-semibold",children:"จำนวนเงิน "}),s("span",{className:"font-semibold ",children:(n==null?void 0:n.Total)!==null&&(n==null?void 0:n.Total)!==void 0?`${n==null?void 0:n.Total} บาท`:"-"})]}),r("div",{className:"flex items-center justify-between",children:[s("p",{className:"text-[#515365] font-semibold",children:"สถานะ"}),s("p",{className:"text-base",children:s("span",{className:"font-semibold",children:(n==null?void 0:n.StatusName)!==null&&(n==null?void 0:n.StatusName)!==void 0?(n==null?void 0:n.StatusName)==="Paid"?"ชำระแล้ว":"ค้างชำระ":"-"})})]}),r("div",{className:"flex items-center justify-between",children:[s("p",{className:"text-[#515365] font-semibold",children:"วันที่ชำระเงิน"}),s("p",{className:"text-base",children:s("span",{className:"font-semibold ",children:(n==null?void 0:n.OrderDateTime)!==null&&(n==null?void 0:n.OrderDateTime)!==void 0?n==null?void 0:n.OrderDateTime:"-"})})]})]}),s("div",{className:"text-center px-2 flex justify-around",children:n!=null&&n.Total||Ye=="dev"?s("button",{type:"button",className:"btn btn-success",onClick:()=>{de({data:{id_contract:_==null?void 0:_.contract_uuid,ins_no:_==null?void 0:_.ins_no,refno:_==null?void 0:_.reference}})},children:"ปรับปรุงข้อมูล"}):s("button",{type:"button",className:"btn btn-success",disabled:!0,children:"ปรับปรุงข้อมูล"})})]})]})]})})})})]})})]})]})};export{Et as default};

import{an as K,a as B,u as Y,r as t,s as X,b as Q,j as c,f,F as Z}from"./index-a90aa29c.js";import{u as q,a as J}from"./useUploadMutation-785f6dd6.js";const ee="admin",oe=()=>{K();const T=B(),A=Y(),S=localStorage.getItem(ee);S&&JSON.parse(S).role;const[E,R]=t.useState(!0),[C,I]=t.useState(null),[k,H]=t.useState(null),[s,U]=t.useState(null),[P,te]=t.useState("environment"),[ie,L]=t.useState(16/9),n=t.useRef(null),p=t.useRef(null),g=t.useRef(null),v=t.useRef(null),b=t.useRef(null),l=t.useRef(null),_=t.useRef(null),D=1010/638,[o,N]=t.useState({left:0,top:0,videoWidth:0,videoHeight:0,cropWidth:0,cropHeight:0}),x=t.useCallback(()=>{const e={video:{width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:25,max:60},facingMode:P},audio:!1};navigator.mediaDevices.getUserMedia(e).then(i=>{if(g.current=i,n.current){n.current.srcObject=i;let a="";n.current.onloadedmetadata=()=>{if(n.current){n.current.play(),L(D),a+=`Container: ${Math.ceil(window.innerWidth)} x ${Math.ceil(window.innerHeight)}, `;const d=n.current.clientWidth,m=n.current.clientHeight;a+=`Video: ${Math.ceil(d)} x ${Math.ceil(m)}, `;const r=window.innerWidth>600?(window.innerWidth-600)/2:30,h=l.current.clientWidth-r*2,u=h/D;l.current.style.width=`${h}px`,a+=`Crop: ${Math.ceil(h)} x ${Math.ceil(u)}, `,v.current.style.borderTop=`${window.innerWidth>600?60:r}px solid #fff`,v.current.style.height=`${n.current.clientHeight-(window.innerWidth>600?60:r)}px`,b.current.style.borderLeft=`${r}px solid #fff`,b.current.style.borderRight=`${r+2}px solid #fff`,b.current.style.borderBottom=`${window.innerHeight-l.current.clientHeight-(window.innerWidth>600?60:r)}px solid #fff`,_.current.style.height=`${window.innerHeight-l.current.clientHeight}px`,_.current.style.display="none",p.current.style.marginTop="20px",p.current.style.marginLeft=`${r}px`,p.current.style.marginBottom="30px",console.log(a),N({left:r,top:0,videoWidth:n.current.clientWidth,videoHeight:n.current.clientHeight,cropWidth:l.current.clientWidth,cropHeight:l.current.clientHeight}),R(!0);return}}}}).catch(i=>{console.error("Camera error:",i),R(!1)})},[P]);q({onSuccess:e=>{const i=new URLSearchParams(window.location.search);i.get("returnUrl")?A(`${i.get("returnUrl")}?citizen_id=${e.data.citizen_id}&name=${e.data.name}&address=${e.data.address}&subdistrict=${e.data.subdistrict}&district=${e.data.district}&province=${e.data.province}&id_district=${e.data.id_district}&id_subdistrict=${e.data.id_subdistrict}&id_province=${e.data.id_province}&zip_code=${e.data.zip_code}&filename=${(s==null?void 0:s.file_name)??""}`):history.back()},onError:e=>{const i=new URLSearchParams(window.location.search);i.get("returnUrl")?A(`${i.get("returnUrl")}?citizen_id=&name=&address=&subdistrict=&district=&province=&id_district=&id_subdistrict=&id_province=&zip_code=&filename=${(s==null?void 0:s.file_name)??""}`):history.back()}});const{mutateAsync:j,isLoading:ne}=J({onSuccess:e=>{U((e==null?void 0:e.data)??null)},onError:e=>{U(null)}}),W=async()=>{if(!n.current||!p.current)return;const e=n.current,i=p.current;i.width=o.cropWidth,i.height=o.cropHeight;const a=i.getContext("2d"),d=e.videoWidth/o.videoWidth;a.drawImage(e,o.left*d,o.top*d,o.cropWidth*d,o.cropHeight*d,0,0,o.cropWidth,o.cropHeight),a.imageSmoothingEnabled=!0,a.imageSmoothingQuality="high";const m=i.toDataURL("image/jpeg",1),r=m.split(",")[1],h=m.split(",")[0].split(":")[1].split(";")[0],u=atob(r),M=new Array(u.length);for(let y=0;y<u.length;y++)M[y]=u.charCodeAt(y);const V=new Uint8Array(M),z=new Blob([V],{type:h}),G=`${new Date().getTime()}.jpeg`,O=new File([z],G,{type:h});_.current.style.display="block",j({data:{file:O??null,type:"customer"}}),H(O??null),I(m)},$=async()=>{if(!k)return;const e=new URLSearchParams(window.location.search);e.get("returnUrl")?A(`${e.get("returnUrl")}?citizen_id=${e.get("citizen_id")??""}&filename=${encodeURIComponent((s==null?void 0:s.file_name)??"")}&image_url=${encodeURIComponent((s==null?void 0:s.image_url)??"")}`):history.back()},w=()=>{g.current&&(g.current.getTracks().forEach(e=>e.stop()),g.current=null)},F=()=>{w(),R(!1)};return t.useEffect(()=>{T(X("ถ่ายภาพ")),T(Q(["services","/apps/services/camera"]))}),t.useEffect(()=>(E?x():F(),()=>w()),[E,x]),c("div",{children:E&&f(Z,{children:[c("div",{className:"d-flex justify-content-center align-items-center bg-dark",style:{zIndex:100,height:"100vh",backgroundColor:"#FFF"},children:f("div",{ref:v,className:"position-relative",style:{position:"relative",width:"100%",backgroundColor:"#FFF"},children:[c("video",{ref:n,style:{zIndex:1,position:"absolute",top:0,left:0,right:0,width:"100%",objectFit:"contain"},playsInline:!0,muted:!0}),f("div",{ref:b,style:{zIndex:2,position:"absolute",top:0,left:0,right:0,width:"100%"},children:[c("img",{ref:l,src:"/assets/images/frame-crop.png",style:{width:"100%"}}),c("button",{className:"btn btn-primary",style:{zIndex:3,position:"absolute",bottom:10,left:C?"calc(50% - 80px)":"calc(50% - 40px)",right:0,display:"block",width:"70px",height:"70px",borderRadius:"999px",fontSize:"14px",border:"none",backgroundColor:"rgba(0,0,0, 0.7)"},onClick:W,children:"ถ่าย"})]})]})}),f("div",{ref:_,style:{zIndex:200,display:"none",position:"absolute",top:0,left:0,right:0,width:"100%",height:"100vh",backgroundColor:"#FFF",textAlign:"center"},children:[c("canvas",{ref:p,style:{maxWidth:"100%",borderRadius:"20px"}}),c("button",{className:"btn btn-primary",style:{zIndex:3,position:"absolute",bottom:50,left:C?"calc(50% - 80px)":"calc(50% - 40px)",right:0,display:"block",width:"70px",height:"70px",borderRadius:"999px",fontSize:"14px",border:"none",backgroundColor:"rgba(0,0,0, 0.7)"},onClick:()=>{_.current.style.display="none",I(null)},children:"ถ่ายใหม่"}),c("button",{className:"btn btn-primary",style:{zIndex:3,position:"absolute",bottom:50,left:"calc(50% + 10px)",right:0,display:"block",width:"70px",height:"70px",borderRadius:"999px",fontSize:"12px"},onClick:$,children:"ยืนยัน"})]})]})})};export{oe as default};

import{a as Y,u as F,ar as Q,r,c as D,s as q,f as n,F as X,j as t,L as Z,t as U,g as N}from"./index-a90aa29c.js";import{S as h}from"./sweetalert2.all-ca2d1030.js";import{n as J}from"./formatNumeric-862380d6.js";const z="admin",se=()=>{const E=Y(),i=F(),O=Q(),y=localStorage.getItem(z),g=y?JSON.parse(y).access_token:null,[L,T]=r.useState(!0),{contractID:l,ins_no:s,payment_preview:d}=O.state||{},[b,M]=r.useState(""),[m,x]=r.useState(""),[_,k]=r.useState(""),[u,H]=r.useState({}),[j,w]=r.useState(""),[A,G]=r.useState({}),f="https://dev-tms-admin.gsrental.cn:7443/api/v1",S=()=>{h.fire({title:"ขออภัย!",text:"สร้าง QR Code ไม่สำเร็จ กรุณากด สร้าง QRCode ใหม่อีกครั้ง",icon:"warning",showCancelButton:!0,confirmButtonColor:U.color.themePrimary,cancelButtonColor:"#d33",confirmButtonText:"ยืนยัน",cancelButtonText:"ยกเลิก",reverseButtons:!0}).then(e=>{e.isConfirmed&&window.location.reload()})},{mutate:V}=D(N.getPayment,{onSuccess:e=>{var o,a,c,I,R,v,C,P;e.data.payment.status==="complete"&&i("/apps/customer-payment/success",{state:{contractID:l,ins_no:s}}),G((o=e==null?void 0:e.data)==null?void 0:o.contract),w((I=(c=(a=e.data.installment)==null?void 0:a.contract)==null?void 0:c.business_unit)==null?void 0:I.line_id),(v=(R=e==null?void 0:e.data)==null?void 0:R.payment_qr)!=null&&v.image&&(k(e.data.payment_qr.image),x(e.data.payment_qr.expiredate),M(e.data.payment_qr.referenceNo),T(!1)),((P=(C=e==null?void 0:e.data)==null?void 0:C.payment_qr)==null?void 0:P.image)==""&&S()},onError:()=>{console.error("Failed to fetch asset type data")}});r.useEffect(()=>{E(q("ชำระเงิน (Payment)")),(async()=>{(!l||!(s!=null&&s.id))&&i("/apps/customer-payment/list");try{V({data:{id_installment:s==null?void 0:s.id,id_contract:l}})}catch{S()}})()},[E,s,l,g,f]),r.useEffect(()=>{if(!m)return;const e=()=>{const a=+new Date(m)-+new Date;let c={};return a>0&&(c={days:Math.floor(a/(1e3*60*60*24)),hours:Math.floor(a/(1e3*60*60)%24),minutes:Math.floor(a/1e3/60%60),seconds:Math.floor(a/1e3%60)}),c},o=setInterval(()=>{H(e())},1e3);return()=>clearInterval(o)},[m]);const{mutate:K}=D(N.paymentCheckStatus,{onSuccess:e=>{var o,a;e.statusCode===400||e.code===400?h.fire({icon:"error",title:"ยกเลิกชำระเงิน",padding:"10px 20px"}).then(()=>{i("/apps/customer-payment/list")}):((o=e.data)==null?void 0:o.status)=="cancel"?h.fire({icon:"error",title:"ยกเลิกชำระเงิน",padding:"10px 20px"}).then(()=>{i("/apps/customer-payment/list")}):((a=e.data)==null?void 0:a.status)=="complete"&&h.fire({icon:"success",title:"ชำระเงินสำเร็จ",padding:"10px 20px"}).then(()=>{i("/apps/customer-payment/success",{state:{contractID:l,ins_no:s,payment_preview:d,payment_qr:b}})})},onError:e=>{T(!1)}});r.useEffect(()=>{const e=setInterval(async()=>{try{K({data:{id_installment:s==null?void 0:s.id,id_contract:l}})}catch(o){console.error("Error checking payment status:",o)}},1e4);return()=>clearInterval(e)},[f,g,b,i]);const B=()=>{const e=document.createElement("a");e.href=_,e.download="qr_code.png",document.body.appendChild(e),e.click(),document.body.removeChild(e)},W=async()=>{try{window.location.reload()}catch(e){window.location.reload(),console.error("Error regenerating QR code:",e)}},p=[];return Object.keys(u).forEach(e=>{u[e]&&p.push(n("span",{children:[u[e]," ",e," "]},e))}),n(X,{children:[n("ul",{className:"flex space-x-2 rtl:space-x-reverse",children:[t("li",{children:t(Z,{to:"/apps/customer-payment/list",className:"text-primary hover:underline",children:"หน้าหลัก"})}),t("li",{className:"before:content-['/'] ltr:before:mr-2 rtl:before:ml-2",children:t("span",{children:"ชำระเงิน (Payment)"})})]}),t("div",{className:"py-10 animate__animated",children:n("div",{className:"panel !px-0",children:[n("div",{className:"flex justify-between flex-wrap gap-4 px-4",children:[t("div",{className:"text-2xl font-semibold uppercase",children:"ชำระเงิน (Payment)"}),t("div",{className:"shrink-0",children:t("img",{src:U.logo.CustomerLogo,alt:"img",className:"w-36 ltr:ml-auto rtl:mr-auto"})})]}),t("div",{className:"ltr:text-left rtl:text-left px-4",children:n("div",{className:"space-y-1 mt-6 text-white-dark",children:[n("div",{children:["เลขที่สัญญา ",A==null?void 0:A.reference]}),n("div",{children:["งวดที่: ",s==null?void 0:s.ins_no]})]})}),t("div",{className:"my-4"}),n("div",{className:"flex justify-between font-bold text-[22px] mt-4",children:[t("div",{className:"p-6 text-[22px] font-bold dark:border-dark dark:text-white",children:"ยอดที่ต้องชำระ"}),n("div",{className:"p-6 text-[22px] font-bold dark:border-dark dark:text-white",children:[J(d==null?void 0:d.total)," บาท"]})]}),n("div",{className:"p-6",children:[L?t("div",{className:"flex justify-center items-center h-full",children:t("span",{className:"animate-spin border-8 border-[#f1f2f3] border-l-primary border-r-primary rounded-full w-14 h-14 inline-block align-middle"})}):t("div",{className:"border-b border-[#ebedf2] dark:border-[#1b2e4b]",children:t("div",{className:"my-4",children:_&&p.length?t("img",{src:_,alt:"QR Code",className:"w-full max-w-xs mx-auto"}):t("div",{children:m})})}),_&&p.length&&t("div",{className:"text-center",children:t("button",{className:"bg-blue-600 text-white py-2 px-4 rounded",onClick:B,children:"บันทึกรูป"})}),t("br",{}),n("div",{className:"text-center",children:[t("div",{className:"py-2",children:"เวลานับถอยหลัง"}),t("div",{children:p.length?p:t("button",{className:"bg-blue-600 text-white py-2 px-4 rounded",onClick:W,children:"สร้าง QR Code ใหม่"})})]}),n("div",{className:"mt-6",children:[t("div",{className:"text-lg font-bold mb-2",children:"ขั้นตอนดำเนินการ"}),n("ol",{className:"list-decimal list-inside text-white-dark text-sm",children:[t("li",{children:'บันทึกรูป QR Code โดยกดปุ่ม "บันทึกรูป"'}),t("li",{children:"เปิดแอปธนาคาร และเลือกวิธีสแกน QR Code"}),t("li",{children:"เปิดรูปที่บันทึกไว้ และสแกน ตกลง เพื่อยืนยันการชำระ"}),t("li",{children:"เมื่อชำระผ่านแอปธนาคารแล้ว กลับมาหน้านี้ และอัปเดต"}),t("li",{children:"เมื่อระบบยืนยันการชำระเรียบร้อยแล้ว จะขึ้นว่า ยืนยันการชำระเรียบร้อย"}),n("li",{children:["หากมีปัญหาการชำระเงิน สามารถติดต่อเจ้าหน้าที่ Line: ",j]})]})]})]})]})})]})};export{se as default};

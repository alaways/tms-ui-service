import{a as ye,u as Se,ao as Te,an as ve,i as De,r as o,m as E,c as X,s as Pe,f as i,F as Ie,j as s,v as Re,g as U}from"./index-a90aa29c.js";import{u as D,w as Ce}from"./xlsx-9a117414.js";import{_ as Z}from"./lodash-f7ec5310.js";import{S as Ue}from"./sweetalert2.all-ca2d1030.js";import{t as xe,s as $}from"./constant-e85f1578.js";import{n as r}from"./formatNumeric-862380d6.js";import{c as Q,b as P}from"./formatDate-4e046265.js";import{u as Ne}from"./useShopMutation-084b0c2e.js";import{S as Oe}from"./react-select.esm-b46d9623.js";import{S as q}from"./Spinner-5dd45779.js";import{F as Me,a as Le}from"./formik.esm-c4fd04ca.js";import{Q as ke}from"./index-2f30bf27.js";import{F as J}from"./DatePicker-5cf5930a.js";import{S as ee}from"./SelectField-917481a8.js";import{I as we}from"./IconRefresh-fed8c080.js";import{B as He}from"./breadcrumbs-b9914bbc.js";import"./createSuper-98fcd92d.js";import"./floating-ui.dom-0aeb9e8a.js";import"./index-8d8bdff8.js";import"./flatpickr-2301360e.js";const je=Ue.mixin(xe),Ye="admin",_t=()=>{var V,G,B,F,K,W;const x=ye(),I=Se(),[R,Ve]=Te(),{id:_}=ve(),b=R.get("id_business_unit")||"",te=[{to:"/apps/shop/list",label:"ร้านค้า"},{label:"รายงานค่าตอบแทน",isCurrent:!0}],se="https://dev-tms-admin.gsrental.cn:7443/api/v1",y=localStorage.getItem(Ye),S=y?JSON.parse(y).role:null,ae=y?JSON.parse(y).access_token:null,T=De(e=>e.dataStore.shop),[v,N]=o.useState(!1),[ne,O]=o.useState(!1),[h,M]=o.useState(null),[m,re]=o.useState([]),[oe,Ge]=o.useState([{value:"all",label:"ทั้งหมด"},{value:"approved",label:"อนุมัติ"},{value:"cancel",label:"ยกเลิก"}]),[c,L]=o.useState({start_at:R.get("startDate")||`${E.tz(new Date,"Asia/Bangkok").format("YYYY-MM-DD")}T00:00:00.000Z`,end_at:R.get("endDate")||`${E.tz(new Date,"Asia/Bangkok").format("YYYY-MM-DD")}T00:00:00.000Z`,id_business_unit:b||"",id_shop:_||"",search:"",status:""}),[g,k]=o.useState({count_item:0,total_commission:0,total_down_payment:0,total_price:0,total_amount:0,total_principle:0,total_benefit:0,total_amount_shop:0,total_fee:0,total_ins_amount:0}),[l,w]=o.useState([]),H=[10,20,30,50,100],[A,j]=o.useState(1),[ie,le]=o.useState(1),[u,de]=o.useState(H[0]),[pe,ce]=o.useState(0),{mutate:_e,isLoading:Be,isError:Fe}=Ne({onSuccess:e=>{const t=e.data;M({...t,id:_||T.id}),me({data:{id_shop:_||T.id}})},onError:e=>{M(T)}}),{mutate:me}=X(U.shopGetBU,{onSuccess:e=>{re(e.data.map(t=>({value:t.id,label:t.name})))},onError:()=>{console.error("Failed to fetch status data")}}),{mutate:Y}=X(U.getCommissionPV,{onSuccess:e=>{e.data!==void 0&&(w(e.data.list),k(e.data.summary),ce(e.data.total)),N(!1)},onError:()=>{console.error("Failed to fetch status data")}}),he=async()=>{const e=new Headers;e.append("Content-Type","application/json"),e.append("Authorization",`Bearer ${ae}`);const t=JSON.stringify({id_shop:c.id_shop,id_business_unit:c.id_business_unit,status:c.status,start_at:c.start_at,end_at:c.end_at,page_size:5e4,page:A}),a={method:"POST",headers:e,body:t,redirect:"follow"};return fetch(se+U.getCommissionPV,a).then(d=>d.json()).then(d=>d.data).catch(d=>[])},ue=async e=>{if(!ne){O(!0);const t=await he(),a=D.json_to_sheet(t.list.map((p,Ke)=>{var z;const n=l.find(Ee=>Ee.id===p.id);return{reference:p.reference,contract_date:P(n==null?void 0:n.contract_date),approved_at:P(p==null?void 0:p.contract_approved_date),asset_name:((z=n==null?void 0:n.asset)==null?void 0:z.name)||"0",asset_price:r((n==null?void 0:n.price)||"0"),down_payment:r((n==null?void 0:n.down_payment)||"0"),principle:r((n==null?void 0:n.principle)||"0"),commission:r((n==null?void 0:n.commission)||"0"),benefit:r((p==null?void 0:p.benefit)||"0"),amount:r((n==null?void 0:n.amount)||"0"),fee:r((n==null?void 0:n.fee)||"0"),total:r((n==null?void 0:n.total)||"-")}}),{header:$.map(p=>p.id)}),d=D.book_new();D.book_append_sheet(d,a,"Sheet1");const C=$.map(p=>p.displayName);D.sheet_add_aoa(a,[C],{origin:"A1"});const ge=Ce(d,{bookType:"xlsx",type:"array"}),Ae=new Blob([ge],{type:"application/octet-stream"}),f=document.createElement("a"),fe=URL.createObjectURL(Ae);f.setAttribute("href",fe),f.setAttribute("download",e+".xlsx"),f.style.visibility="hidden",document.body.appendChild(f),f.click(),document.body.removeChild(f),O(!1)}},be=e=>{I("/apps/contract/"+e.id+"/"+e.uuid)};return o.useEffect(()=>{S!=="admin"&&S!=="business_unit"&&I("/")},[S,I]),o.useEffect(()=>{x(Pe("รายการร้านค้า"))},[x]),o.useEffect(()=>{_e({data:{id:_||T.id}}),b&&L(e=>({...e,id_business_unit:b!==""?parseInt(b):""}))},[b]),o.useEffect(()=>{const t=ie!==u?1:A;if(!h)return;const a=c.id_business_unit!==""?parseInt(c.id_business_unit):+b,d=(_==null?void 0:_.trim())!==""?_:0;a!=0&&(Y({data:{id_shop:d,id_business_unit:a,page:t,page_size:u,start_at:c.start_at,end_at:c.end_at,status:c.status}}),le(u))},[h,A,u]),i(Ie,{children:[s(He,{items:te}),s("div",{className:"panel px-0 border-white-light dark:border-[#1b2e4b] mt-3",children:i("div",{className:"invoice-table",children:[i("div",{className:"ml-10 mt-3 text-lg font-semibold ltr:sm:text-left rtl:sm:text-right text-center flex flex-row justify-between",children:["ร้านค้า ",(h==null?void 0:h.name)||"-"]}),s("div",{className:"p-10",children:i("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-6 gap-6 mb-6 text-white",children:[i("div",{className:"panel bg-gradient-to-r from-cyan-500 to-cyan-400",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"ทุนเช่าซื้อ"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:((V=g.total_principle)==null?void 0:V.toLocaleString())||"0"})})]}),i("div",{className:"panel bg-gradient-to-r from-violet-500 to-violet-400",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"ค่านายหน้า"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:((G=g.total_commission)==null?void 0:G.toLocaleString())||"0"})})]}),i("div",{className:"panel bg-gradient-to-r from-blue-500 to-blue-400",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"รวมเป็นเงิน"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:((B=g.total_amount)==null?void 0:B.toLocaleString())||"0"})})]}),i("div",{className:"panel bg-gradient-to-r from-fuchsia-500 to-fuchsia-400",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"ค่าทำสัญญา"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:((F=g.total_fee)==null?void 0:F.toLocaleString())||"0"})})]}),i("div",{className:"panel bg-gradient-to-r from-yellow-500 to-yellow-400",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"คงเหลือให้ร้านค้า"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:((K=g.total_amount_shop)==null?void 0:K.toLocaleString())||"0"})})]}),i("div",{className:"panel bg-gradient-to-r from-red-500 to-orange-500",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"ราคารวมผ่อน"})}),s("div",{className:"flex items-center mt-5",children:i("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:[" ",((W=g.total_ins_amount)==null?void 0:W.toLocaleString())||"0"]})})]})]})}),s("div",{className:"mb-4.5 px-5 flex md:items-center md:flex-row flex-col gap-5",children:s(Me,{initialValues:c,onSubmit:(e,{resetForm:t})=>{if(Z.isEmpty(e.start_at)||Z.isEmpty(e.end_at)||e.start_at===""||e.end_at==="")je.fire({icon:"warning",title:"กรุณาเลือกข้อมูลวันที่ให้ครบเพื่อค้นหา",padding:"10px 20px"});else{N(!0);const a=Array.isArray(e.start_at)&&Array.isArray(e.end_at),d=a?E.tz(e.start_at[0],"Asia/Bangkok").format("YYYY-MM-DD"):E.tz(e.start_at,"Asia/Bangkok").format("YYYY-MM-DD"),C=a?E.tz(e.end_at[0],"Asia/Bangkok").format("YYYY-MM-DD"):E.tz(e.end_at,"Asia/Bangkok").format("YYYY-MM-DD");L({id_shop:h.uuid,id_business_unit:e.id_business_unit,start_at:e.start_at,end_at:e.end_at,page_size:u,page:A,status:e.status}),Y({data:{id_shop:h.id,id_business_unit:parseInt(e.id_business_unit),start_at:`${d}T00:00:00.000Z`,end_at:`${C}T23:59:59.000Z`,page_size:u,page:A,status:e.status}})}},onReset:()=>{w([]),k(e=>({...e,count_item:0,total_commission:0,total_down_payment:0,total_price:0,total_amount:0,total_principle:0,total_benefit:0,total_amount_shop:0}))},enableReinitialize:!0,children:({setFieldValue:e,handleReset:t})=>i(Le,{className:"flex items-center gap-2",children:[s(J,{label:"วันที่เริ่ม",name:"start_at",onChange:a=>{e("start_at",Q(a))}}),s(J,{label:"วันที่สิ้นสุด",name:"end_at",onChange:a=>{e("end_at",Q(a))}}),S==="business_unit"?i("div",{children:[s("label",{children:"หน่วยธุรกิจ"}),s(Oe,{defaultValue:m.length===0?null:{label:m[0].label,value:m[0].value.id},value:m.length===0?null:{label:m[0].label,value:m[0].value.id},placeholder:"เลือก หน่วยธุรกิจ",className:"pr-1 z-10 w-[200px]",options:m.map(a=>({label:a.label,value:a.value.id})),isDisabled:!0})]}):s(ee,{id:"id_business_unit",name:"id_business_unit",label:"หน่วยธุรกิจ",className:"pr-1 z-10 w-[200px]",options:m,isSearchable:!0,onChange:a=>{e("id_business_unit",a.value)}}),s(ee,{id:"status",name:"status",label:"สถานะสัญญา",className:"pr-1 z-10 w-[200px]",options:oe,isSearchable:!1,onChange:a=>{e("status",a.value)}}),i("button",{type:"submit",className:"btn btn-primary gap-2 mt-5",disabled:v,children:[v?s(q,{size:"sm"}):s(Re,{}),"ค้นหา"]}),i("button",{type:"reset",className:"btn btn-info gap-2 mt-5",disabled:v,onClick:t,children:[v?s(q,{size:"sm"}):s(we,{}),"ล้างค่า"]}),s("div",{className:"flex flex-col pt-5",children:s("button",{type:"button",className:"btn btn-success gap-2 w-full h-[40px]",onClick:()=>ue(`shop_report_${new Date().toLocaleString()}`),children:"Export"})})]})})}),s("div",{className:"datatables pagination-padding",children:l.length===0?s("div",{className:"text-center text-gray-500",children:"ไม่พบข้อมูล"}):s(ke,{className:"whitespace-nowrap table-hover invoice-table",records:l,columns:[{accessor:"id",title:"เลขที่สัญญา",textAlignment:"center",sortable:!1,render:e=>s("div",{className:"flex justify-center text-center font-normal",children:s("a",{className:"flex cursor-pointer active",onClick:()=>be(e),children:e.reference})})},{accessor:"contract_date",title:"วันที่ทำสัญญา",sortable:!1,render:e=>{const t=l.find(a=>a.id===e.id);return P(t==null?void 0:t.contract_date)}},{accessor:"approved_at",title:"วันที่อนุมัติสัญญา",textAlignment:"left",sortable:!1,render:e=>P(e==null?void 0:e.contract_approved_date)},{accessor:"contract_status",title:"สถานะสัญญา",textAlignment:"left",sortable:!1,render:e=>(e==null?void 0:e.contract_status)||"-"},{accessor:"asset.name",title:"ชื่อทรัพย์สิน",textAlignment:"left",sortable:!1,render:e=>{var a;const t=l.find(d=>d.id===e.id);return((a=t==null?void 0:t.asset)==null?void 0:a.name)||"0"}},{accessor:"price",title:"ราคาขาย",textAlignment:"right",sortable:!1,render:e=>{const t=l.find(a=>a.id===e.id);return r((t==null?void 0:t.price)||"0")}},{accessor:"down_payment",title:"เงินดาวน์",textAlignment:"right",sortable:!1,render:e=>{const t=l.find(a=>a.id===e.id);return r((t==null?void 0:t.down_payment)||"0")}},{accessor:"principle",title:"ทุนเช่าซื้อ",textAlignment:"right",sortable:!1,render:e=>{const t=l.find(a=>a.id===e.id);return r((t==null?void 0:t.principle)||"0")}},{accessor:"commission",title:"ค่านายหน้า",textAlignment:"right",sortable:!1,render:e=>{const t=l.find(a=>a.id===e.id);return r((t==null?void 0:t.commission)||"0")}},{accessor:"benefit",title:"ผลตอบแทนพิเศษ",textAlignment:"right",sortable:!1,render:e=>r((e==null?void 0:e.benefit)||"0")},{accessor:"amount",title:"รวมเป็นเงิน",textAlignment:"right",sortable:!1,render:e=>{const t=l.find(a=>a.id===e.id);return r((t==null?void 0:t.amount)||"0")}},{accessor:"fee",title:"ค่าทำสัญญา",textAlignment:"right",sortable:!1,render:e=>{const t=l.find(a=>a.id===e.id);return r((t==null?void 0:t.fee)||"0")}},{accessor:"total",title:"คงเหลือให้ร้านค้า",textAlignment:"right",sortable:!1,render:e=>{const t=l.find(a=>a.id===e.id);return r((t==null?void 0:t.total)||"-")}},{accessor:"total",title:"ราคารวมผ่อน",textAlignment:"right",sortable:!1,render:e=>{const t=l.find(a=>a.id===e.id);return r((t==null?void 0:t.total_ins_amount)||"-")}}],page:A,highlightOnHover:!0,totalRecords:pe,recordsPerPage:u,onPageChange:e=>j(e),recordsPerPageOptions:H,onRecordsPerPageChange:e=>{j(1),de(e)},paginationText:({from:e,to:t,totalRecords:a})=>`โชว์ ${e} ถึง ${t} ของ ${a} หน้าทั้งหมด`})})]})})]})};export{_t as default};

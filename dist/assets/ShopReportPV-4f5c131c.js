import{a as Ee,u as ve,ao as De,an as xe,i as Ie,r as l,m as T,c as J,s as Pe,f as i,F as C,j as s,v as Ce,N as Ne,g as ee}from"./index-a90aa29c.js";import{u as N,w as Re}from"./xlsx-9a117414.js";import{_ as te}from"./lodash-f7ec5310.js";import{S as Ue}from"./sweetalert2.all-ca2d1030.js";import{t as Oe,s as se}from"./constant-e85f1578.js";import{n as o}from"./formatNumeric-862380d6.js";import{c as g,b as D}from"./formatDate-4e046265.js";import{u as Me}from"./useShopMutation-084b0c2e.js";import{S as Le}from"./react-select.esm-b46d9623.js";import{S as ne}from"./Spinner-5dd45779.js";import{F as we,a as ke}from"./formik.esm-c4fd04ca.js";import{Q as He}from"./index-2f30bf27.js";import{F as R}from"./DatePicker-5cf5930a.js";import{S as ae}from"./SelectField-917481a8.js";import{I as je}from"./IconRefresh-fed8c080.js";import{B as Ye}from"./breadcrumbs-b9914bbc.js";import{I as Ge}from"./IconEdit-bf2b08f0.js";import"./createSuper-98fcd92d.js";import"./floating-ui.dom-0aeb9e8a.js";import"./index-8d8bdff8.js";import"./flatpickr-2301360e.js";const Be=Ue.mixin(Oe),Ve="admin",Ke=E=>{if(E=="approved")return"อนุมัติ";if(E=="cancel")return"ยกเลิก"},bt=()=>{var $,W,z,Z,X,Q;const E=Ee(),U=ve(),[O,Fe]=De(),{id:m}=xe(),u=O.get("id_business_unit")||"",oe=[{to:"/apps/report/pay-to-shop-pv",label:"จ่ายเงินให้ร้านค้า"},{label:"รายงานค่าตอบแทน",isCurrent:!0}],re="https://dev-tms-admin.gsrental.cn:7443/api/v1",x=localStorage.getItem(Ve),A=x?JSON.parse(x).role:null,ie=x?JSON.parse(x).access_token:null,M=Ie(e=>e.dataStore.shop),[I,L]=l.useState(!1),[le,j]=l.useState(!1),[f,Y]=l.useState(null),[h,G]=l.useState([]);l.useState([]);const[c,w]=l.useState({start_at:O.get("startDate")||`${T.tz(new Date,"Asia/Bangkok").format("YYYY-MM-DD")}T00:00:00.000Z`,end_at:O.get("endDate")||`${T.tz(new Date,"Asia/Bangkok").format("YYYY-MM-DD")}T00:00:00.000Z`,id_business_unit:u||"",id_shop:m||"",search:"",status:""}),[y,B]=l.useState({count_item:0,total_commission:0,total_down_payment:0,total_price:0,total_amount:0,total_principle:0,total_benefit:0,total_amount_shop:0,total_fee:0,total_ins_amount:0}),[d,V]=l.useState([]),K=[10,20,30,50,100],[b,F]=l.useState(1),[ce,pe]=l.useState(1),[_,de]=l.useState(K[0]),[_e,me]=l.useState(0),[v,P]=l.useState("");l.useState({start_at:null,end_at:null});const ue=[{accessor:"id",title:"เลขที่สัญญา",textAlignment:"center",sortable:!1,render:e=>s("div",{className:"flex justify-center text-center font-normal",children:s("a",{className:"flex cursor-pointer active",onClick:()=>Ae(e),children:e.reference})})},{accessor:"no_pv",title:"เลขที่ PV",textAlignment:"center",sortable:!1,render:e=>s("p",{children:e==null?void 0:e.pv_no})},{accessor:"date_pv",title:"วันที่สร้าง PV",textAlignment:"center",sortable:!1,render:e=>D(e.pv_create)},{accessor:"contract_date",title:"วันที่ทำสัญญา",sortable:!1,render:e=>{const t=d.find(n=>n.id===e.id);return D(t==null?void 0:t.contract_date)}},{accessor:"approved_at",title:"วันที่อนุมัติสัญญา",textAlignment:"left",sortable:!1,render:e=>D(e==null?void 0:e.contract_approved_date)},{accessor:"contract_status",title:"สถานะ PV",textAlignment:"left",sortable:!1,render:e=>s("p",{className:`${e.contract_status=="cancel"?"text-red-500":"text-green-600"} !font-semibold`,children:Ke(e==null?void 0:e.contract_status)||""})},{accessor:"asset.name",title:"ชื่อทรัพย์สิน",textAlignment:"left",sortable:!1,render:e=>{var n;const t=d.find(r=>r.id===e.id);return e.isTotal?"ผลรวม":((n=t==null?void 0:t.asset)==null?void 0:n.name)||""}},{accessor:"price",title:"ราคาขาย",textAlignment:"right",sortable:!1,render:e=>{const t=d.find(n=>n.id===e.id);return e.isTotal?`${o((t==null?void 0:t.price)||"0")} บาท`:o((t==null?void 0:t.price)||"0")}},{accessor:"down_payment",title:"เงินดาวน์",textAlignment:"right",sortable:!1,render:e=>{const t=d.find(n=>n.id===e.id);return e.isTotal?`${o((t==null?void 0:t.down_payment)||"0")} บาท`:o((t==null?void 0:t.down_payment)||"0")}},{accessor:"principle",title:"ทุนเช่าซื้อ",textAlignment:"right",sortable:!1,render:e=>{const t=d.find(n=>n.id===e.id);return e.isTotal?`${o((t==null?void 0:t.principle)||"0")} บาท`:o((t==null?void 0:t.principle)||"0")}},{accessor:"commission",title:"ค่านายหน้า",textAlignment:"right",sortable:!1,render:e=>{const t=d.find(n=>n.id===e.id);return e.isTotal?`${o((t==null?void 0:t.commission)||"0")} บาท`:o((t==null?void 0:t.commission)||"0")}},{accessor:"benefit",title:"ผลตอบแทนพิเศษ",textAlignment:"right",sortable:!1,render:e=>e.isTotal?`${o((e==null?void 0:e.benefit)||"0")} บาท`:o((e==null?void 0:e.benefit)||"0")},{accessor:"amount",title:"รวมเป็นเงิน",textAlignment:"right",sortable:!1,render:e=>{const t=d.find(n=>n.id===e.id);return e.isTotal?`${o((t==null?void 0:t.amount)||"0")} บาท`:o((t==null?void 0:t.amount)||"0")}},{accessor:"fee",title:"ค่าทำสัญญา",textAlignment:"right",sortable:!1,render:e=>{const t=d.find(n=>n.id===e.id);return e.isTotal?`${o((t==null?void 0:t.fee)||"0")} บาท`:o((t==null?void 0:t.fee)||"0")}},{accessor:"total",title:"คงเหลือให้ร้านค้า",textAlignment:"right",sortable:!1,render:e=>{const t=d.find(n=>n.id===e.id);return e.isTotal?`${o((t==null?void 0:t.total)||"-")} บาท`:o((t==null?void 0:t.total)||"-")}},{accessor:"total_ins_amount",title:"ราคารวมผ่อน",textAlignment:"right",sortable:!1,render:e=>e.isTotal?`${o((e==null?void 0:e.total_ins_amount)||"-")} บาท`:o((e==null?void 0:e.total_ins_amount)||"-")},...A!=="shop"?[{accessor:"action",title:"Actions",textAlignment:"center",sortable:!1,render:e=>s(C,{children:!e.isTotal&&s("div",{className:"flex gap-4 items-center w-max mx-auto",children:i("a",{href:`/apps/report/pay-to-shop-pv/edit/${e.uuid}?id_business_unit=${u}&id_shop=${m}`,className:"flex cursor-pointer items-center relative group",children:[s(Ge,{className:"w-4.5 h-4.5 flex items-center transition-opacity duration-200 group-hover:opacity-0"}),s("p",{className:"absolute left-[-5px] text-center text-blue-500 opacity-0 transition-opacity duration-200 group-hover:opacity-100",children:"แก้ไข"})]})})})}]:[]],{mutate:he,isLoading:$e,isError:We}=Me({onSuccess:e=>{const t=e.data;Y({...t,id:m||M.id}),A!=="business_unit"&&u!==""?G(t.shop_group_relations.map(n=>({value:n.business_unit.id.toString(),label:n.business_unit.name}))):be({})},onError:e=>{Y(M)}}),{mutate:be}=J(ee.contractFilter,{onSuccess:e=>{G(e.data.business_unit.map(t=>({value:t.id,label:t.name})))},onError:()=>{console.error("Failed to fetch status data")}}),{mutate:k}=J(ee.getCommissionPV,{onSuccess:e=>{if(e.data!==void 0){const t=e.data.list.reduce((r,p)=>(r.amount+=p.amount||0,r.commission+=p.commission||0,r.down_payment+=p.down_payment||0,r.fee+=p.fee||0,r.price+=p.price||0,r.principle+=p.principle||0,r.total+=p.total||0,r.total_ins_amount+=p.total_ins_amount||0,r.benefit+=p.benefit||0,r),{amount:0,commission:0,down_payment:0,fee:0,price:0,principle:0,total:0,total_ins_amount:0,benefit:0}),n=e.data.list.concat({...t,isTotal:!0});V(n),B(e.data.summary),me(e.data.total)}L(!1)},onError:e=>{L(!1)}}),ge=async()=>{const e=new Headers;e.append("Content-Type","application/json"),e.append("Authorization",`Bearer ${ie}`);const t=JSON.stringify({id_shop:c.id_shop,id_business_unit:+c.id_business_unit,start_at:c.start_at,end_at:c.end_at,page_size:5e4,page:b,...c.status&&{status:c.status}}),n={method:"POST",headers:e,body:t,redirect:"follow"};return fetch(re+"/shop/pv/get-commission",n).then(r=>r.json()).then(r=>r.data).catch(r=>[])},fe=async e=>{if(!le){j(!0);const t=await ge(),n=N.json_to_sheet(t.list.map((a,ze)=>{var q;return{reference:a.reference,contract_date:D(a==null?void 0:a.contract_date),approved_at:D(a==null?void 0:a.contract_approved_date),asset_name:((q=a==null?void 0:a.asset)==null?void 0:q.name)||"0",asset_price:o((a==null?void 0:a.price)||"0"),down_payment:o((a==null?void 0:a.down_payment)||"0"),principle:o((a==null?void 0:a.principle)||"0"),commission:o((a==null?void 0:a.commission)||"0"),benefit:o((a==null?void 0:a.benefit)||"0"),amount:o((a==null?void 0:a.amount)||"0"),fee:o((a==null?void 0:a.fee)||"0"),total:o((a==null?void 0:a.total)||"-")}}),{header:se.map(a=>a.id)}),r=N.book_new();N.book_append_sheet(r,n,"Sheet1");const p=se.map(a=>a.displayName);N.sheet_add_aoa(n,[p],{origin:"A1"});const ye=Re(r,{bookType:"xlsx",type:"array"}),Se=new Blob([ye],{type:"application/octet-stream"}),S=document.createElement("a"),Te=URL.createObjectURL(Se);S.setAttribute("href",Te),S.setAttribute("download",e+".xlsx"),S.style.visibility="hidden",document.body.appendChild(S),S.click(),document.body.removeChild(S),j(!1)}},Ae=e=>{U("/apps/contract/"+(e==null?void 0:e.contract_id)+"/"+(e==null?void 0:e.contract_uuid))},H=(e,t)=>{if(e=="all")P("all");else if(e=="today")P("today"),t("start_at",g(new Date().toISOString())),t("end_at",g(new Date().toISOString()));else if(e=="month"){P("month");const n=new Date,r=new Date(Date.UTC(n.getFullYear(),n.getMonth(),1)),p=new Date(Date.UTC(n.getFullYear(),n.getMonth()+1,0));t("start_at",g(r.toISOString())),t("end_at",g(p.toISOString()))}else P("custom")};return l.useEffect(()=>{A!=="admin"&&A!=="business_unit"&&U("/")},[A,U]),l.useEffect(()=>{E(Pe("รายงานค่าตอบแทน"))},[E]),l.useEffect(()=>{he({data:{id:m||M.id}}),u&&w(e=>({...e,id_business_unit:u!==""?u:""}))},[u]),l.useEffect(()=>{const e=ce!==_;k({data:{id_shop:m!==void 0&&m!==""?m:0,id_business_unit:+c.id_business_unit,page:e?1:b,page_size:_,start_at:c.start_at,end_at:c.end_at,status:c.status}}),pe(_)},[b,_]),i(C,{children:[s(Ye,{items:oe}),s("div",{className:"panel px-0 border-white-light dark:border-[#1b2e4b] mt-3",children:i("div",{className:"invoice-table",children:[i("div",{className:"ml-10 mt-3 text-lg font-semibold ltr:sm:text-left rtl:sm:text-right text-center flex flex-row justify-between",children:["ร้านค้า ",(f==null?void 0:f.name)||"-"]}),s("div",{className:"p-10",children:i("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6 mb-6 text-white",children:[i("div",{className:"panel bg-gradient-to-r from-cyan-500 to-cyan-400",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"ทุนเช่าซื้อ"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:(($=y.total_principle)==null?void 0:$.toLocaleString())||"0"})})]}),i("div",{className:"panel bg-gradient-to-r from-violet-500 to-violet-400",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"ค่านายหน้า"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:((W=y.total_commission)==null?void 0:W.toLocaleString())||"0"})})]}),i("div",{className:"panel bg-gradient-to-r from-blue-500 to-blue-400",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"รวมเป็นเงิน"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:((z=y.total_amount)==null?void 0:z.toLocaleString())||"0"})})]}),i("div",{className:"panel bg-gradient-to-r from-fuchsia-500 to-fuchsia-400",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"ค่าทำสัญญา"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:((Z=y.total_fee)==null?void 0:Z.toLocaleString())||"0"})})]}),i("div",{className:"panel bg-gradient-to-r from-yellow-500 to-yellow-400",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"คงเหลือให้ร้านค้า"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:((X=y.total_amount_shop)==null?void 0:X.toLocaleString())||"0"})})]}),i("div",{className:"panel bg-gradient-to-r from-red-500 to-orange-500",children:[s("div",{className:"flex justify-between",children:s("div",{className:"ltr:mr-1 rtl:ml-1 text-md font-semibold text-xl",children:"ราคารวมผ่อน"})}),s("div",{className:"flex items-center mt-5",children:s("div",{className:"text-3xl font-bold ltr:mr-3 rtl:ml-3",children:((Q=y.total_ins_amount)==null?void 0:Q.toLocaleString())||"0"})})]})]})}),s("div",{className:"mb-4.5 px-5 flex md:items-center md:flex-row flex-col gap-5 custom-select",children:s(we,{initialValues:c,onSubmit:(e,{resetForm:t})=>{te.isEmpty(e.start_at)||te.isEmpty(e.end_at)||e.start_at===""||e.end_at===""?Be.fire({icon:"warning",title:"กรุณาเลือกข้อมูลวันที่ให้ครบเพื่อค้นหา",padding:"10px 20px"}):(L(!0),typeof e.start_at!="string"&&typeof e.end_at!="string"?(w({id_shop:f.uuid,id_business_unit:e.id_business_unit,start_at:e.start_at,end_at:e.end_at,page_size:_,page:b,status:e.status}),k({data:{id_shop:f.id,id_business_unit:parseInt(e.id_business_unit),start_at:`${T.tz(e.start_at[0],"Asia/Bangkok").format("YYYY-MM-DD")}T00:00:00.000Z`,end_at:`${T.tz(e.end_at[0],"Asia/Bangkok").format("YYYY-MM-DD")}T23:59:59.000Z`,page_size:_,page:b,status:e.status}})):(w({id_shop:f.uuid,id_business_unit:e.id_business_unit,start_at:e.start_at,end_at:e.end_at,page_size:_,page:b,status:e.status}),k({data:{id_shop:f.id,id_business_unit:parseInt(e.id_business_unit),start_at:`${T.tz(e.start_at,"Asia/Bangkok").format("YYYY-MM-DD")}T00:00:00.000Z`,end_at:`${T.tz(e.end_at,"Asia/Bangkok").format("YYYY-MM-DD")}T23:59:59.000Z`,page_size:_,page:b,status:e.status}})))},onReset:()=>{V([]),B(e=>({...e,count_item:0,total_commission:0,total_down_payment:0,total_price:0,total_amount:0,total_principle:0,total_benefit:0,total_amount_shop:0,total_ins_amount:0}))},enableReinitialize:!0,children:({setFieldValue:e,handleReset:t})=>i(ke,{className:"flex flex-col gap-3",children:[i("div",{className:"flex gap-2",children:[A==="business_unit"?i("div",{children:[s("label",{children:"หน่วยธุรกิจ"}),s(Le,{defaultValue:h.length===0?null:{label:h[0].label,value:h[0].value.id},value:h.length===0?null:{label:h[0].label,value:h[0].value.id},placeholder:"เลือก หน่วยธุรกิจ",className:"pr-1 z-10 w-[200px]",options:h.map(n=>({label:n.label,value:n.value.id})),isDisabled:!0})]}):s(ae,{id:"id_business_unit",name:"id_business_unit",label:"หน่วยธุรกิจ",className:"pr-1 z-10 w-[200px]",options:h,isSearchable:!0,onChange:n=>{e("id_business_unit",n.value)}}),s(ae,{id:"status",name:"status",label:"สถานะ PV",className:"pr-1 w-[200px]",options:[{value:"",label:"ทั้งหมด"},{value:"approved",label:"อนุมัติ"},{value:"cancel",label:"ยกเลิก"}],isSearchable:!1,onChange:n=>{e("status",n.value)}})]}),i("div",{className:"flex gap-2 items-center",children:[s("label",{htmlFor:"",children:"วันที่อนุมัติสัญญา"}),s("button",{type:"button",onClick:()=>H("today",e),className:`${v=="today"?"bg-blue-500 text-white font-semibold":null} border rounded-[5px] px-4 py-2`,children:"วันนี้"}),s("button",{type:"button",onClick:()=>H("month",e),className:`${v=="month"?"bg-blue-500 text-white font-semibold":null} border rounded-[5px] px-4 py-2`,children:"เดือนนี้"}),s("button",{type:"button",onClick:()=>H("custom",e),className:`${v=="custom"?"bg-blue-500 text-white font-semibold":null} border rounded-[5px] px-4 py-2`,children:"กำหนดเอง"}),v!="custom"&&i(C,{children:[s(R,{name:"start_at",onChange:n=>{e("start_at",g(n))},disabled:!0}),s(R,{name:"end_at",onChange:n=>{e("end_at",g(n))},disabled:!0})]}),v=="custom"&&i(C,{children:[s(R,{name:"start_at",onChange:n=>{e("start_at",g(n))}}),s(R,{name:"end_at",onChange:n=>{e("end_at",g(n))}})]})]}),i("div",{className:"flex gap-2 items-center",children:[i("button",{type:"submit",className:"btn btn-primary gap-2 mt-5",disabled:I,children:[I?s(ne,{size:"sm"}):s(Ce,{}),"ค้นหา"]}),i("button",{type:"reset",className:"btn btn-info gap-2 mt-5",disabled:I,onClick:t,children:[I?s(ne,{size:"sm"}):s(je,{}),"ล้างค่า"]}),s("div",{className:"flex flex-col pt-5",children:s("button",{type:"button",className:"btn btn-success gap-2 w-full h-[40px]",onClick:()=>fe(`shop_report_${new Date().toLocaleString()}`),children:"Export"})}),s(Ne,{to:`/apps/report/account-creditor?id_business_unit=${u}&id_shop=${m}&start_at=${c.start_at}&end_at=${c.end_at}`,className:"btn bg-yellow-500 text-white shadow-lg gap-2 mt-5",children:"ธุรกรรมร้านค้า"})]})]})})}),s("div",{className:"datatables pagination-padding",children:d.length===0?s("div",{className:"text-center text-gray-500",children:"ไม่พบข้อมูล"}):s(He,{className:"whitespace-nowrap table-hover invoice-table",records:d,columns:ue,page:b,totalRecords:_e,recordsPerPage:_,onPageChange:e=>F(e),recordsPerPageOptions:K,onRecordsPerPageChange:e=>{F(1),de(e)},rowClassName:e=>e.isTotal?"!bg-white font-bold text-black":"",paginationText:({from:e,to:t,totalRecords:n})=>`โชว์ ${e} ถึง ${t} ของ ${n} หน้าทั้งหมด`})})]})})]})};export{bt as default};

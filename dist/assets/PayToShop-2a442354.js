import{u as se,a as ne,r,s as ae,b as oe,c as I,f as u,F as ie,j as s,g as P}from"./index-a90aa29c.js";import{u as h,w as re}from"./xlsx-9a117414.js";import{F as le,a as pe}from"./formik.esm-c4fd04ca.js";import{Q as _e}from"./index-2f30bf27.js";import{S as D}from"./react-select.esm-b46d9623.js";import{F as C}from"./DatePicker-5cf5930a.js";import{P as ce}from"./preLoading-b2445d9d.js";import{t as de,h as L}from"./constant-e85f1578.js";import{c as i}from"./formatDate-4e046265.js";import{B as me}from"./breadcrumbs-b9914bbc.js";import{S as ue}from"./sweetalert2.all-ca2d1030.js";import"./floating-ui.dom-0aeb9e8a.js";import"./createSuper-98fcd92d.js";import"./flatpickr-2301360e.js";const he=ue.mixin(de),O="admin",Le=()=>{const N=se(),E=ne(),x="https://dev-tms-admin.gsrental.cn:7443/api/v1",_=localStorage.getItem(O),c=_?JSON.parse(_).role:null,M=_?JSON.parse(_).access_token:null,k=_?JSON.parse(_).id_business_unit:null;c!="admin"&&c!="business_unit"&&N("/");const H=[{to:"/",label:"รายงาน"},{label:"จ่ายเงินให้ร้านค้า",isCurrent:!0}];r.useEffect(()=>{E(ae("รายงานจ่ายเงินให้ร้านค้า")),E(oe(["report","/apps/report/pay-to-shop"]))});const{mutate:T,isLoading:w}=I(P.leasingReportFindAll,{onSuccess:e=>{K(e.data.list),G(e.data.total)},onError:()=>{console.error("Failed to fetch asset type data")}}),[be,y]=r.useState(!1),[f,U]=r.useState(!1),v=[10,20,30,50,100],[b,g]=r.useState(1),[m,j]=r.useState(v[0]),[V,G]=r.useState(0),[p,F]=r.useState([]),[B,K]=r.useState([]),[a,W]=r.useState({id_business_unit:c=="business_unit"?+k:"",start_at:"",end_at:""}),[Y,X]=r.useState({columnAccessor:"",direction:"asc"}),z=(e,t,l)=>{y(!0);const o=c==="business_unit"?p[0].value.id:a.id_business_unit;T({data:{page:t,page_size:l,start_at:i(a.start_at),end_at:i(a.end_at),id_business_unit:o,query:e.query}})},{mutate:$}=I(P.contractFilter,{onSuccess:e=>{F(e.data.business_unit.map(t=>({value:t,label:t.name})))},onError:()=>{console.error("Failed to fetch asset type data")}}),A=(e,t)=>{W(l=>({...l,[t]:e}))},q=async()=>{const e=new Headers;e.append("Content-Type","application/json"),e.append("Authorization",`Bearer ${M}`);const t=JSON.stringify({id_business_unit:a.id_business_unit,page:1,page_size:5e4,start_at:i(a.start_at),end_at:i(a.end_at)}),l={method:"POST",headers:e,body:t,redirect:"follow"};return fetch(x+"/admin/leasing-report",l).then(o=>o.json()).then(o=>o.data).catch(o=>[])},Z=async e=>{if(!f){U(!0);const t=await q(),l=t.list.reduce((n,S)=>n+S.count_contract,0);t.list=[{no:0,business_unit_name:"",shop_name:"",count_contract:0,price:0,down_payment:0,principle:0,commission:0,benefit:0,amount:0,fee:0,total:0,bank_name:"",bank_account_name:"",bank_account_number:""},...t.list];const o=h.json_to_sheet(t.list.map((n,S)=>({no:S,business_unit_name:n.business_unit_name,shop_name:n.shop_name,count_contract:n.count_contract.toLocaleString("en-US"),price:n.price.toLocaleString("en-US"),down_payment:n.down_payment.toLocaleString("en-US"),principle:n.principle.toLocaleString("en-US"),commission:n.commission.toLocaleString("en-US"),benefit:n.benefit.toLocaleString("en-US"),amount:n.amount.toLocaleString("en-US"),fee:n.fee.toLocaleString("en-US"),total:n.total.toLocaleString("en-US"),bank_name:(n==null?void 0:n.bank_name)||"-",bank_account_name:(n==null?void 0:n.bank_account_name)||"-",bank_account_number:(n==null?void 0:n.bank_account_number)||"-"})),{header:L.map(n=>n.id)}),R=h.book_new();h.book_append_sheet(R,o,"Sheet1");const J=L.map(n=>n.displayName);h.sheet_add_aoa(o,[["ระหว่างวันที่",`${i(a.start_at)} - ${i(a.end_at)}`,"","","","","","","","","","","","จำนวนสัญญา",l]],{origin:"A1"}),h.sheet_add_aoa(o,[J],{origin:"A2"});const Q=re(R,{bookType:"xlsx",type:"array"}),ee=new Blob([Q],{type:"application/octet-stream"}),d=document.createElement("a"),te=URL.createObjectURL(ee);d.setAttribute("href",te),d.setAttribute("download",e+".xlsx"),d.style.visibility="hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d),U(!1)}};return r.useEffect(()=>{if(a.id_business_unit===""||a.start_at==""||a.end_at==""){$({});return}T({data:{page:b,page_size:m,id_business_unit:a.id_business_unit,start_at:i(a.start_at),end_at:i(a.end_at)}})},[b,m]),u(ie,{children:[s(me,{items:H}),(w||f)&&s(ce,{}),u("div",{className:"panel px-0 border-white-light dark:border-[#1b2e4b] mt-5",children:[s("div",{children:s(le,{initialValues:a,onSubmit:e=>{const t=c==="business_unit"?!1:e.id_business_unit==="";a.start_at===""||a.end_at===""||t?he.fire({icon:"warning",title:"กรุณาเลือกข้อมูลวันที่และหน่วยธุรกิจให้ครบเพื่อค้นหา",padding:"10px 20px"}):(y(!0),g(1),z({...e,start_at:i(a.start_at),end_at:i(a.end_at)},1,m))},children:({values:e,setFieldValue:t,resetForm:l})=>s(pe,{className:"flex flex-col flex-auto gap-2",children:u("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5 mb-5 px-5",children:[u("div",{className:"flex-1",children:[s("label",{children:"หน่วยธุรกิจ"}),c==="business_unit"?s(D,{defaultValue:p.length===0?null:{label:p[0].label,value:p[0].value.id},value:p.length===0?null:{label:p[0].label,value:p[0].value.id},placeholder:"เลือก หน่วยธุรกิจ",className:"z-10 w-auto",options:p.map(o=>({label:o.label,value:o.value.id})),isDisabled:!0}):s(D,{value:e.id_business_unit,placeholder:"เลือก หน่วยธุรกิจ",className:"z-10 w-auto",options:p,isSearchable:!0,onChange:o=>{t("id_business_unit",o),A(o.value.id,"id_business_unit")}})]}),s(C,{label:"วันอนุมัติสัญญา",name:"start_at",onChange:o=>{A(o,"start_at")}}),s(C,{label:"ถึงวันที่",name:"end_at",onChange:o=>{A(o,"end_at")}}),s("div",{className:"flex flex-col mt-1 pt-5",children:s("button",{type:"submit",className:"btn btn-primary gap-2 w-full h-[40px]",children:"ค้นหา"})}),s("div",{className:"flex flex-col mt-1 pt-5",children:s("button",{type:"button",className:"btn btn-success gap-2 w-full h-[40px]",onClick:()=>{Z(`report_${new Date().toLocaleString()}`)},children:"Export"})})]})})})}),s("div",{className:"invoice-table px-5",children:u("div",{className:"datatables pagination-padding",children:[O==="business_unit",s(_e,{className:"whitespace-nowrap table-hover invoice-table",records:B,columns:[{accessor:"id",title:"ลำดับ",textAlignment:"center",sortable:!1,render:(e,t)=>t+1+(b-1)*m},{accessor:"business_unit_name",title:"หน่วยธุรกิจ",textAlignment:"left",sortable:!1,render:e=>s("p",{children:e.business_unit_name})},{accessor:"shop_name",title:"ร้านค้า",textAlignment:"left",sortable:!1,render:e=>s("div",{className:"flex items-center font-normal",children:s("a",{className:"flex cursor-pointer active",href:`/apps/shop/report/${e.id_shop}?startDate=${i(a.start_at)}&endDate=${i(a.end_at)}&id_business_unit=${a.id_business_unit}`,target:"_blank",children:s("div",{children:e.shop_name})})})},{accessor:"count_contract",title:"จำนวนสัญญา",textAlignment:"center",sortable:!1,render:(e,t)=>s("p",{children:e.count_contract})},{accessor:"price",title:"รวมราคาขาย",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.price.toLocaleString("en-US")})},{accessor:"down_payment",title:"รวมเงินดาวน์",textAlignment:"right",sortable:!1,render:(e,t)=>s("div",{children:e.down_payment.toLocaleString("en-US")})},{accessor:"principle",title:"รวมทุนเช่าซื้อ",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.principle.toLocaleString("en-US")})},{accessor:"commission",title:"รวมค่านายหน้า",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.commission.toLocaleString("en-US")})},{accessor:"benefit",title:"ผลตอบแทนพิเศษ",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.benefit.toLocaleString("en-US")})},{accessor:"amount",title:"รวมเป็นเงิน",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.amount.toLocaleString("en-US")})},{accessor:"fee",title:"ค่าทำสัญญา",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.fee?e.fee.toLocaleString("en-US"):""})},{accessor:"total",title:"คงเหลือให้ร้านค้า",textAlignment:"right",sortable:!1,render:(e,t)=>s("p",{children:e.total.toLocaleString("en-US")})}],page:b,totalRecords:V,recordsPerPage:m,highlightOnHover:!0,onPageChange:e=>g(e),recordsPerPageOptions:v,onRecordsPerPageChange:e=>{g(1),j(e)},sortStatus:Y,onSortStatusChange:X,paginationText:({from:e,to:t,totalRecords:l})=>`โชว์ ${e} ถึง ${t} ของ ${l} หน้าทั้งหมด`})]})})]})]})};export{Le as default};

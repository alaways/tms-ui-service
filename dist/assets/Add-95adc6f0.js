import{u as Ee,a as Se,r as o,s as Ce,c as m,j as t,f as i,F as H,g as u}from"./index-a90aa29c.js";import{c as ve,a as A}from"./object-7405de1d.js";import{S as I}from"./sweetalert2.all-ca2d1030.js";import{F as Te,a as Ie}from"./formik.esm-c4fd04ca.js";import{C}from"./react-select-creatable.esm-cd844a3e.js";import{I as h}from"./InputField-d7971719.js";import{S as F}from"./SelectField-917481a8.js";import{u as Ne,a as xe}from"./useAssetMutation-f9664723.js";import{a as Pe}from"./useUploadMutation-785f6dd6.js";import{_ as De}from"./index-f89ea186.js";import{B as Le}from"./breadcrumbs-b9914bbc.js";import{P as Re}from"./regex-a1235873.js";import{t as N}from"./constant-e85f1578.js";import{r as Ue}from"./helpFunction-19eb552d.js";import{P as Me}from"./preLoading-b2445d9d.js";import"./_defineProperty-6dbd93ca.js";import"./_baseIsEqual-06123cd3.js";import"./isObjectLike-b76e75a8.js";import"./isSymbol-15555f2d.js";import"./react-select.esm-b46d9623.js";import"./createSuper-98fcd92d.js";import"./floating-ui.dom-0aeb9e8a.js";import"./lodash-f7ec5310.js";const ke="admin",da=()=>{const d=I.mixin(N),y=Ee(),j=Se();o.useEffect(()=>{j(Ce("เพิ่มสินทรัพย์"))});const V=[{to:"/apps/asset/list",label:"สินทรัพย์"},{label:"เพิ่ม",isCurrent:!0}],f=localStorage.getItem(ke),x=f?JSON.parse(f).id_shop:null;JSON.parse(f);const g=f?JSON.parse(f).role:null;g!="admin"&&g!="shop"&&g!="business_unit"&&y("/");const P={id_asset_type:"",id_shop:x,name:"",model_number:"",capacity:"",color:"",serial_number:"",imei:"",insurance_type_id:"",price:0,note:"",is_active:!0},[l,D]=o.useState(P),[G,K]=o.useState([]),[q,B]=o.useState([]),[W,Y]=o.useState([]),[z,X]=o.useState([]),[J,Z]=o.useState([]),[Q,$]=o.useState([]),[Oe,ee]=o.useState([]),[we,ae]=o.useState([]),[He,te]=o.useState([]),[Fe,se]=o.useState([]),[b,E]=o.useState([]),[n,L]=o.useState(0),{mutate:S}=m(u.shopSearchContains,{onSuccess:e=>{K(e.data.map(a=>({value:a.id,label:a.name})))},onError:e=>{d.fire({icon:"error",title:e.massage,padding:"10px 20px"})}});o.useEffect(()=>{S({data:{}}),U({data:{}}),ne({data:{page:1,page_size:-1}})},[]);const{mutateAsync:R,isLoading:ie}=Pe({onSuccess:e=>{},onError:e=>{}}),{mutate:ne,isLoading:re}=m(u.assetTypeFindAllActive,{onSuccess:e=>{B(e.data.map(a=>({value:a.id,label:a.name})))},onError:()=>{}}),{mutate:oe}=m(u.assetColorFindAll,{onSuccess:e=>{const a=e.data.map(s=>({value:s.name,label:s.name}));Y(a),ee(a)},onError:()=>{}}),{mutate:le}=m(u.assetModelFindAll,{onSuccess:e=>{const a=e.data.map(s=>({value:s.name,label:s.name}));X(a),ae(a)},onError:()=>{}}),{mutate:de}=m(u.assetNameFindAll,{onSuccess:e=>{const a=e.data.map(s=>({value:s.id,label:s.name}));Z(a),te(a)},onError:()=>{}}),{mutate:U}=m(u.assetCapacityFindAll,{onSuccess:e=>{const a=e.data.map(s=>({value:s.name,label:s.name}));$(a),se(a)},onError:()=>{}}),{mutate:M,isLoading:v}=m(u.assetCreate,{onSuccess:async(e,a)=>{if(e.statusCode===200||e.code===200){const s=[];if(b.forEach(c=>{s.push(R({data:{file:c.file,type:"asset"}}))}),s.length>0){const c=await Promise.all(s),r=[];c.forEach(p=>{p.code!=="error"?r.push(O({data:{id_asset:e.data.id,name:p.data.file_name,image_url:p.data.file_name,extension:"extension",size:p.data.size}})):I.mixin(N).fire({icon:"error",title:"เพิ่มไฟล์ผิดพลาดกรุณาใช้ไฟล์ที่เป็นรูปเท่านั้น",padding:"10px 20px"})}),r.length>0&&await Promise.all(r)}d.fire({icon:"success",title:"บันทึกสำเร็จ",padding:"10px 20px"}),y("/apps/asset/list")}else d.fire({icon:"error",title:e==null?void 0:e.message,padding:"10px 20px"})},onError:e=>{d.fire({icon:"error",title:e.massage,padding:"10px 20px"})}}),{mutateAsync:ce}=Ne(),{mutate:k}=xe({onSuccess:async e=>{var a;if(e.statusCode===200||e.code===200){const s=[],c=[];if((a=l.asset_images)==null||a.forEach(r=>{b.find(_=>_.id===r.id)===void 0&&c.push(ce({data:{id:r.id}}))}),b.forEach(r=>{(r==null?void 0:r.id)===void 0&&s.push(R({data:{file:r.file,type:"asset"}}))}),c.length>0&&await Promise.all(c),s.length>0){const r=await Promise.all(s),p=[];r.forEach(_=>{_.code!=="error"?p.push(O({data:{id_asset:e.data.id,name:_.data.file_name,image_url:_.data.file_name,extension:"extension",size:_.data.size}})):I.mixin(N).fire({icon:"error",title:"เพิ่มไฟล์ผิดพลาดกรุณาใช้ไฟล์ที่เป็นรูปเท่านั้น",padding:"10px 20px"})}),p.length>0&&await Promise.all(p)}d.fire({icon:"success",title:"แก้ไขสำเร็จ",padding:"10px 20px"}),y("/apps/asset/list")}else d.fire({icon:"error",title:e==null?void 0:e.message,padding:"10px 20px"})},onError:e=>{d.fire({icon:"error",title:e.massage,padding:"10px 20px"})}}),{mutateAsync:O}=m(u.assetImgCreate,{}),{mutate:w}=m(u.assetSearch,{onSuccess:async(e,a)=>{var s,c;e.code===400||e.statusCode===400?(E([]),L(1),D(P)):(L(2),S({data:{query:e.data.shop.name}}),((s=e.data)==null?void 0:s.asset_images.length)>0&&E((c=e.data)==null?void 0:c.asset_images.map(r=>({dataURL:r.image_url,name:r.name,id:r.id}))),D({...e.data,id_shop:e.data.shop.uuid}))}}),pe=(e,a,s)=>{S({data:{query:a}})},me=(e,a,s)=>{le({data:{id_asset_type:e.values.id_asset_type,id_asset_name:a==null?void 0:a.value}}),oe({data:{id_asset_type:e.values.id_asset_type,id_asset_name:a==null?void 0:a.value}}),U({data:{id_asset_type:e.values.id_asset_type,id_asset_name:a==null?void 0:a.value}}),e.setFieldValue("capacity",""),e.setFieldValue("color",""),e.setFieldValue("model_number","")},ue=(e,a,s)=>{de({data:{id_asset_type:a.value}}),e.setFieldValue("name",a.value)},{mutate:_e}=m(u.changeAssetShop,{onSuccess:e=>{d.fire({icon:"success",title:"แก้ไขสำเร็จ",padding:"10px 20px"}),y("/apps/asset/list")},onError:e=>{d.fire({icon:"error",title:e.massage,padding:"10px 20px"})}}),he=o.useCallback(e=>{e.uuid?g=="shop"?n==1?k({data:{...e,id:e.uuid}}):_e({data:{id_asset:e.uuid}}):k({data:{...e,id:e.uuid}}):M({data:{...e,price:Number(e.price)}})},[M,b]),ge=async(e,a)=>{const s=await Ue(e);E(s)},be=()=>{d.fire({icon:"error",title:"รูปภาพเกิน 15 รูป",padding:"10px 20px"})},fe=ve().shape({name:A().required("กรุณาใส่ข้อมูลให้ครบ"),id_shop:A().required("กรุณาใส่ข้อมูลให้ครบ"),id_asset_type:A().required("กรุณาใส่ข้อมูลให้ครบ"),serial_number:A().required("กรุณาใส่ข้อมูลให้ครบ"),price:A().required("กรุณาใส่ข้อมูลให้ครบ").matches(Re,"กรุณาใส่ราคาให้ถูกต้อง")});return re?t("div",{children:"Loading..."}):i("div",{className:"flex flex-col gap-2.5",children:[(ie||v)&&t(Me,{}),t(Le,{items:V}),t("div",{className:"panel px-6 flex-1 py-6 ltr:xl:mr-6 rtl:xl:ml-6",children:t(Te,{initialValues:l,onSubmit:he,enableReinitialize:!0,autoComplete:"off",validationSchema:fe,children:e=>i(Ie,{className:"space-y-5 dark:text-white custom-select",children:[(l==null?void 0:l.on_contract)===!0&&t("div",{className:"w-full bg-[#fedee2] text-[#f9303e] rounded-md",children:i("div",{className:"p-5",children:["หมายเลขซีเรียลนี้ อยู่ระหว่างการทำสัญญากับ ",l==null?void 0:l.bu_name]})}),t("div",{className:"input-flex-row",children:i("div",{className:"w-full",children:[t(h,{require:!0,label:"หมายเลขซีเรียล",name:"serial_number",type:"text",onKeyPress:a=>{if(a.key==="Enter"){a.preventDefault(),e.values.serial_number?w({data:{query:e.values.serial_number},props:e}):d.fire({icon:"error",title:"กรุณากรอกหมายเลขซีเรียลก่อนค้นหา",padding:"10px 20px"});return}}}),t("button",{type:"button",className:"btn btn-dark mt-2 w-full border-0 uppercase shadow-[0_10px_20px_-10px_rgba(67,97,238,0.44)]",onClick:()=>{e.values.serial_number?w({data:{query:e.values.serial_number},props:e}):d.fire({icon:"error",title:"กรุณากรอกหมายเลขซีเรียลก่อนค้นหา",padding:"10px 20px"})},children:"ตรวจสอบ"}),t("p",{className:"mt-4 text-[11px] text-white-dark",children:"หากพบจะแสดงข้อมูลสินทรัพย์ หากไม่พบจะแสดงแบบฟอร์มให้สร้างบัญชีสินทรัพย์ใหม่ได้"})]})}),n===1||n===2?i(H,{children:[i("div",{className:"input-flex-row",children:[!x&&t(F,{require:!0,id:"id_shop",label:"ร้านค้า",name:"id_shop",options:G,isSearchable:!0,onInputChange:a=>{pe(e,a)},handleOnMenuOpen:()=>{S({data:{query:""}})}}),t(F,{require:!0,id:"id_asset_type",label:"ประเภทสินทรัพย์",name:"id_asset_type",options:q,disabled:n===2,onChange:a=>{ue(e,a)}})]}),i("div",{className:"input-flex-row",children:[t("div",{className:"input-container",children:n===2?t(h,{label:"ชื่อสินทรัพย์",name:"name",require:!0,disabled:!0}):i("div",{children:[i("label",{children:["ชื่อสินทรัพย์ ",t("span",{className:"text-rose-600",children:" * "})]}),t("div",{className:"relative text-white-dark",children:t(C,{id:"name",placeholder:"ชื่อสินทรัพย์",name:"name",isClearable:!0,options:J,onChange:a=>{e.setFieldValue("name",a?a.label:""),me(e,a)}})})]})}),t("div",{className:"input-container",children:n===2?t(h,{label:"หมายเลขรุ่น",name:"model_number",disabled:!0}):i("div",{children:[t("label",{children:"หมายเลขรุ่น"}),t("div",{className:"relative text-white-dark",children:t(C,{id:"model_number",placeholder:"หมายเลขรุ่น",name:"model_number",isClearable:!0,options:z,onChange:a=>{e.setFieldValue("model_number",a?a.label:"")}})})]})})]}),i("div",{className:"input-flex-row",children:[t("div",{className:"input-container",children:n===2?t(h,{label:"ความจุ",name:"capacity",disabled:!0}):i("div",{children:[t("label",{children:"ความจุ"}),t("div",{className:"relative text-white-dark",children:t(C,{id:"capacity",placeholder:"ความจุ",name:"capacity",isClearable:!0,options:Q,onChange:a=>{e.setFieldValue("capacity",a?a.label:"")}})})]})}),t("div",{className:"input-container",children:n===2?t(h,{label:"ความจุ",name:"capacity",disabled:!0}):i("div",{children:[t("label",{children:"สี"}),t("div",{className:"relative text-white-dark",children:t(C,{id:"color",placeholder:"สี",name:"color",isClearable:!0,options:W,onChange:a=>{e.setFieldValue("color",a?a.label:"")}})})]})})]}),i("div",{className:"input-flex-row",children:[t(h,{label:"หมายเลข IMEI",name:"imei",maxLength:15,type:"text",disabled:n===2,onKeyPress:a=>{/[0-9]/.test(a.key)||a.preventDefault()}}),t(h,{require:!0,label:"ราคาขาย",name:"price",disabled:n===2,onKeyPress:a=>{/[0-9]/.test(a.key)||a.preventDefault()}})]}),t("div",{className:"input-flex-row",children:t(h,{label:"ข้อสังเกตุ",name:"note",as:"textarea",rows:"4",placeholder:"กรุณาใส่ข้อมูล",className:"form-textarea ltr:rounded-l-none rtl:rounded-r-none resize-none",disabled:n===2})}),t("div",{className:"input-flex-row",children:i("div",{className:"custom-file-container","data-upload-id":"Image",children:[i("div",{className:"label-container",children:[t("label",{children:" รูปสินทรัพย์ "}),n===1&&b.length>0&&t("button",{type:"button",className:"custom-file-container__image-clear",title:"Clear Image",onClick:()=>{E([])},children:"×"})]}),t("label",{className:`custom-file-container__custom-file ${n===2&&"hidden"}`}),t("input",{type:"file",className:"custom-file-container__custom-file__custom-file-input hidden",accept:"image/*"}),t("input",{type:"hidden",name:"MAX_FILE_SIZE",value:"10485760"}),t(De,{multiple:!0,value:b,onChange:ge,onError:be,maxNumber:15,children:({imageList:a,onImageUpload:s,onImageRemoveAll:c,onImageUpdate:r,onImageRemove:p,isDragging:_,dragProps:Ae})=>i("div",{className:"upload__image-wrapper",children:[n===1&&t("button",{type:"button",className:"custom-file-container__custom-file__custom-file-control custom-btn-select-file",onClick:s,children:"เลือกไฟล์..."}),t("div",{className:"grid gap-4 sm:grid-cols-3 grid-cols-1",children:a.map((ye,T)=>i("div",{className:"custom-file-container__image-preview relative",children:[n===1&&t("button",{type:"button",className:"custom-file-container__image-clear bg-dark-light dark:bg-dark dark:text-white-dark rounded-full block w-fit p-1 absolute top-0 right-0 z-10",title:"Clear Image",onClick:()=>p(T),children:"×"}),t("div",{className:"custom-file-container__image-preview relative",children:t("img",{src:ye.dataURL,alt:"img",className:"m-auto"})},T)]},T))})]})})]})}),(n==2&&(l==null?void 0:l.on_contract)===!1&&g!="shop"||n==1)&&i("button",{type:"submit",className:"btn !mt-6 w-full border-0 btn-primary",children:[v&&t("span",{className:"animate-spin border-2 border-white border-l-transparent rounded-full w-5 h-5 ltr:mr-4 rtl:ml-4 inline-block align-middle"}),"บันทึก"]}),n==2&&(l==null?void 0:l.on_contract)===!1&&g=="shop"&&i("button",{type:"submit",className:"btn !mt-6 w-full border-0 btn-primary",children:[v&&t("span",{className:"animate-spin border-2 border-white border-l-transparent rounded-full w-5 h-5 ltr:mr-4 rtl:ml-4 inline-block align-middle"}),"เพิ่มสินทรัพย์เข้าร้านค้า"]})]}):t(H,{})]})})})]})};export{da as default};

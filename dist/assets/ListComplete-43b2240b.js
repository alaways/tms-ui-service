import{a as ne,r as a,c as N,ay as oe,s as ae,f as i,j as t,F as b,g as E}from"./index-a90aa29c.js";import{Q as re}from"./index-2f30bf27.js";import{P as O}from"./config-8de56c22.js";import{F as ie,a as le}from"./formik.esm-c4fd04ca.js";import{E as ce}from"./exceljs.min-510e5116.js";import{S as f}from"./SelectField-917481a8.js";import{I as pe}from"./InputField-d7971719.js";import{e as L}from"./constant-e85f1578.js";import{b as m}from"./formatDate-4e046265.js";import{I as de}from"./IconOpenBook-4986b63e.js";import{P as _e}from"./preLoading-b2445d9d.js";import{D as y}from"./DateRangeAntd-92e3cf4d.js";import{I as M}from"./IconChecks-e4ba7579.js";import"./floating-ui.dom-0aeb9e8a.js";import"./react-select.esm-b46d9623.js";import"./createSuper-98fcd92d.js";import"./lodash-f7ec5310.js";import"./buddhistEra-a2d9672b.js";import"./index-8d8bdff8.js";const he="admin",Oe=()=>{const d=localStorage.getItem(he),k="https://dev-tms-admin.gsrental.cn:7443/api/v1",T=ne(),n=d?JSON.parse(d).role:null,w=d?JSON.parse(d).access_token:null,[S,H]=a.useState([]),[_,I]=a.useState(1);a.useState(1);const[c,j]=a.useState(O[0]),[V,G]=a.useState(0),[F,K]=a.useState([]),[B,W]=a.useState([]),[R,P]=a.useState(!1),[C,Y]=a.useState({}),[u,X]=a.useState([]),U=e=>{open("/apps/contract/"+e.id+"/"+e.uuid,"_blank")},z=(e,{resetForm:s})=>{const o={...e,status_type:"credit",start_at:"",end_at:"",page:1,page_size:c,...(e==null?void 0:e.contract_date[0])&&{contract_date:e==null?void 0:e.contract_date[0],contract_end_date:e==null?void 0:e.contract_date[1]},...(e==null?void 0:e.closed_at[0])&&{closed_at:e==null?void 0:e.closed_at[0],closed_end_at:e==null?void 0:e.closed_at[1]},...(e==null?void 0:e.approved_at[0])&&{approved_at:e==null?void 0:e.approved_at[0],approved_end_at:e==null?void 0:e.approved_at[1]},is_completed:e==null?void 0:e.is_completed};o==null||delete o.contract_close_date,Y(o),D({data:o})},{mutate:q}=N(E.contractFilter,{onSuccess:e=>{K(e.data.business_unit.map(s=>({value:s.id,label:s.name}))),W(e.data.status.filter(s=>[11,12,13,14,15,16,17,33,34,18].includes(+s.status_code)).map(s=>({value:s.status_code,label:s.name})))},onError:()=>{console.error("Failed to fetch asset type data")}}),{mutate:D,isLoading:$}=N(E.contractCompleteFindAll,{onSuccess:e=>{var s;H(e.data.list),G(e.data.total),Z({data:{contract_list:(s=e.data)==null?void 0:s.ids}})},onError:()=>{console.error("Failed to fetch contract data")}}),{mutate:Z}=oe("/chat/check-unread",{onSuccess:e=>{X(e==null?void 0:e.data)}}),J=async()=>{const e=new Headers;e.append("Content-Type","application/json"),e.append("Authorization",`Bearer ${w}`);const s=JSON.stringify({...C,page:1,page_size:999999,format:"excel"}),o={method:"POST",headers:e,body:s,redirect:"follow"};return fetch(k+E.contractCompleteFindAll,o).then(l=>l.json()).then(l=>l.data).catch(l=>[])},Q=async(e,s)=>{if(!R){P(!0);const o=await J(),l=L.map(r=>r.id),v=L.map(r=>r.displayName||r.id),x=new ce.Workbook,g=x.addWorksheet("Sheet 1");g.addRow(v),o.forEach(r=>{const A=l.map(h=>(r==null?void 0:r[h])??"");g.addRow(A)}),g.columns.forEach((r,A)=>{var h;r.width=Math.max(10,((h=v[A])==null?void 0:h.length)||10)});const te=await x.xlsx.writeBuffer(),se=new Blob([te],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),p=document.createElement("a");p.href=URL.createObjectURL(se),p.download=`${e}.xlsx`,document.body.appendChild(p),p.click(),document.body.removeChild(p),P(!1)}},ee=[{accessor:"index",title:"ลำดับ",textAlignment:"center",render:(e,s)=>t("p",{children:s+1+(_-1)*c})},{accessor:"close_contract_at",title:"วันที่ปิดสัญญา",textAlignment:"left",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{className:"pointer",children:m(e==null?void 0:e.close_contract_at)??"-"}):"-"},{accessor:"credit",title:"สถานะดำเนินการ",textAlignment:"left",sortable:!1,render:e=>{var s;return t("p",{children:((s=e.credit)==null?void 0:s.code)??"-"})}},{accessor:"id",title:"เลขสัญญา",textAlignment:"center",sortable:!1,render:e=>{var o;const s=(o=u==null?void 0:u.find(l=>l.id_contract===e.id))==null?void 0:o.unread;return n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t(b,{children:i("div",{className:"pointer flex items-center space-x-2 active",onClick:()=>U(e),children:[t("span",{className:`w-3 h-3 rounded-full ${s>0?"bg-red-500":"bg-gray-300"}`}),t("span",{children:e.reference})]})}):t(b,{children:i("div",{className:"flex items-center space-x-2",children:[t("span",{className:`w-3 h-3 rounded-full ${s>0?"bg-red-500":"bg-gray-300"}`}),t("span",{children:e.reference})]})})}},{accessor:"business_unit",title:"หน่วยธุรกิจ",textAlignment:"left",sortable:!1,render:e=>{var s;return t("p",{className:"pointer",children:(s=e==null?void 0:e.business_unit)==null?void 0:s.name})}},{accessor:"shop",title:"ร้านค้า",textAlignment:"left",sortable:!1,render:e=>t("p",{children:e.shop.name})},{accessor:"contract_type",title:"ประเภทสัญญา",textAlignment:"left",sortable:!1,render:e=>{var s;return t("p",{children:(s=e==null?void 0:e.contract_type)==null?void 0:s.name})}},{accessor:"ins_due_at",title:"งวดแรกเริ่มเมื่อ",textAlignment:"left",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{className:"pointer",children:m(e==null?void 0:e.ins_due_at)??"-"}):"-"},{accessor:"contract_date",title:"วันที่ทำสัญญา",textAlignment:"left",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{className:"pointer",children:m(e==null?void 0:e.contract_date)??"-"}):"-"},{accessor:"approved_at",title:"วันที่อนุมัติ",textAlignment:"left",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{className:"pointer",children:m(e==null?void 0:e.approved_at)??"-"}):"-"},{accessor:"customer",title:"ชื่อลูกค้า",textAlignment:"left",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{children:e.customer.name}):"-"},{accessor:"ins_pay_day",title:"ชำระทุกวันที่",textAlignment:"center",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{children:e.ins_pay_day}):"-"},{accessor:"ins_amount",title:"ค่างวด",textAlignment:"center",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{children:e.ins_amount?e.ins_amount.toLocaleString("en-US"):"-"}):"-"},{accessor:"price",title:"ราคา",textAlignment:"right",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{children:e.price?e.price.toLocaleString("en-US"):"-"}):"-"},{accessor:"down_payment",title:"ชำระเงินดาวน์",textAlignment:"right",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{children:e.down_payment?e.down_payment.toLocaleString("en-US"):"-"}):"-"},{accessor:"principle",title:"ทุนเช่าซื้อ",textAlignment:"right",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{children:e.principle?e.principle.toLocaleString("en-US"):"-"}):"-"},{accessor:"ins_period",title:"จำนวนงวด",textAlignment:"center",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("p",{children:(e==null?void 0:e.ins_period)??"-"}):"-"},{accessor:"customer_signature_at",title:"ลงนามออนไลน์",textAlignment:"center",sortable:!1,render:e=>n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop"?t("span",{className:`${e!=null&&e.customer_signature_at?"badge-outline-success":"badge-outline-danger"}`,children:e!=null&&e.customer_signature_at?t(M,{className:"w-6 h-6"}):""}):t(b,{})},{accessor:"e_contract_status",title:"ลงนาม Ekyc",textAlignment:"center",sortable:!1,render:e=>t("span",{className:`${e!=null&&e.e_contract_status?"badge-outline-success":"badge-outline-danger"}`,children:e!=null&&e.e_contract_status?t(M,{className:"w-6 h-6"}):""})},{accessor:"action",title:"Actions",sortable:!1,textAlignment:"center",render:e=>(n=="shop"&&(e==null?void 0:e.is_view)==1||n!="shop")&&t("div",{className:"flex gap-4 items-center w-max mx-auto",children:t("a",{className:"flex cursor-pointer active",onClick:()=>U(e),children:t(de,{})})})}].filter(Boolean);return a.useEffect(()=>{q({data:{is_approved:!0}})},[]),a.useEffect(()=>{D({data:{...C,page:_,page_size:c}})},[_,c]),a.useEffect(()=>{T(ae("รายการสัญญาที่สิ้นสุด"))},[T]),i("div",{className:"panel px-0 border-white-light dark:border-[#1b2e4b]",children:[($||R)&&t(_e,{}),i("div",{className:"invoice-table",children:[t("div",{className:"flex w-full mb-4.5 px-5 md:items-center md:flex-row flex-col gap-5 custom-select",children:t(ie,{enableReinitialize:!0,initialValues:{contract_date:"",contract_end_date:"",closed_at:"",closed_end_at:"",approved_at:"",approved_end_at:"",query:"",status_code:"",id_business_unit:"",is_completed:"all",is_locked:"all"},onSubmit:z,children:({setFieldValue:e,handleReset:s,values:o})=>i(le,{className:"flex flex-col flex-auto gap-2",children:[i("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5",children:[t("div",{className:"flex-1",children:t(f,{label:"หน่วยธุรกิจ",placeholder:"เลือก หน่วยธุรกิจ",isSearchable:!0,id:"id_business_unit",name:"id_business_unit",options:F})}),t("div",{className:"flex-1",children:t(f,{label:"สถานะการดำเนินการ",placeholder:"เลือก สถานะ",isSearchable:!0,id:"status_code",name:"status_code",options:B})}),t(f,{label:"สถานะการล็อคเครื่อง",placeholder:"เลือก สถานะการล็อคเครื่อง",isSearchable:!0,id:"is_locked",name:"is_locked",options:[{value:"all",label:"ทั้งหมด"},{value:"locked",label:"ล๊อคเครื่อง"},{value:"unlocked",label:"ปลดล๊อค"}]})]}),i("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5 pt-3",children:[t(y,{label:"วันที่ทำสัญญา",name:"contract_date"}),t(y,{label:"วันที่อนุมัติ",name:"approved_at"}),t("div",{className:"flex-1",children:t(y,{label:"วันที่ปิดสัญญา",name:"closed_at"})})]}),i("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5 pt-3",children:[t("div",{className:"flex-1",children:t(pe,{label:"ค้นหา",id:"query",name:"query"})}),i("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5 justify-end items-start sm:items-end flex-1",children:[t("button",{type:"submit",className:"btn btn-primary gap-2 w-full h-[40px] sm:w-auto",children:"ค้นหา"}),t("button",{type:"reset",className:"btn btn-info gap-2 w-full sm:w-auto",onClick:()=>{location.reload()},children:"ล้างค่า"}),(n==="admin"||n==="business_unit")&&t("button",{type:"button",className:"btn btn-success gap-2 w-full h-[40px] sm:w-auto",onClick:()=>{Q(`contract_${new Date().toLocaleString()}`)},children:"Export"})]})]})]})})}),t("div",{className:"datatables pagination-padding",children:S.length==0?t("div",{className:"my-10 text-center text-gray-500",children:"ไม่พบข้อมูล"}):t(re,{className:"whitespace-nowrap table-hover invoice-table",records:S,columns:ee,page:_,totalRecords:V,recordsPerPage:c,onPageChange:e=>I(e),recordsPerPageOptions:O,onRecordsPerPageChange:e=>{I(1),j(e)},highlightOnHover:!0,paginationText:({from:e,to:s,totalRecords:o})=>`โชว์ ${e} ถึง ${s} ของ ${o} หน้าทั้งหมด`})})]})]})};export{Oe as default};

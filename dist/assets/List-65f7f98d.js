import{ak as le,a as pe,r,s as de,c as C,ay as _e,f as i,j as t,g as v}from"./index-a90aa29c.js";import{u as I,w as me}from"./xlsx-9a117414.js";import{Q as ue}from"./index-2f30bf27.js";import{F as he,a as be}from"./formik.esm-c4fd04ca.js";import{S as g}from"./react-select.esm-b46d9623.js";import{D as ge}from"./DateRangeAntd-92e3cf4d.js";import{P as H}from"./config-8de56c22.js";import{e as j}from"./constant-e85f1578.js";import{b as Ae}from"./formatDate-4e046265.js";import{I as ye}from"./IconPlus-4c7e79c8.js";import{I as Ee}from"./InputField-d7971719.js";import{I as fe}from"./IconOpenBook-4986b63e.js";import{P as Te}from"./preLoading-b2445d9d.js";import{I as G}from"./IconChecks-e4ba7579.js";import"./floating-ui.dom-0aeb9e8a.js";import"./createSuper-98fcd92d.js";import"./buddhistEra-a2d9672b.js";import"./index-8d8bdff8.js";const Se="admin",Ke=()=>{const{t:s}=le(),R=pe(),[V,K]=r.useState(!1);r.useEffect(()=>{K(!0)},[]),r.useEffect(()=>{R(de(s("contract_list")))},[R]);const F="https://dev-tms-admin.gsrental.cn:7443/api/v1",A=localStorage.getItem(Se),y=A?JSON.parse(A).role:null,B=A?JSON.parse(A).access_token:null,[D,U]=r.useState(!1),[N,W]=r.useState([]),[E,f]=r.useState(1),[l,Y]=r.useState(H[0]),[z,X]=r.useState(0),[$,q]=r.useState([]),[Z,Q]=r.useState([]),[p,J]=r.useState([]),[T,ee]=r.useState({ct_status_1:0,ct_status_2:0,ct_status_3:0,ct_status_4:0}),[x,O]=r.useState({}),[P,te]=r.useState([]),{mutate:S,isLoading:se}=C(v.contractFindAll,{onSuccess:e=>{var n,o,a,d,_,m,u,c,h;W(e.data.list),X(e.data.total),ae({data:{contract_list:(n=e.data)==null?void 0:n.ids}}),ee({ct_status_1:((a=(o=e.data)==null?void 0:o.bu_dashboard)==null?void 0:a.ct_status_1)||0,ct_status_2:((_=(d=e.data)==null?void 0:d.bu_dashboard)==null?void 0:_.ct_status_2)||0,ct_status_3:((u=(m=e.data)==null?void 0:m.bu_dashboard)==null?void 0:u.ct_status_3)||0,ct_status_4:((h=(c=e.data)==null?void 0:c.bu_dashboard)==null?void 0:h.ct_status_4)||0})},onError:()=>{console.error("Failed to fetch contract data")}}),{mutate:ae}=_e("/chat/check-unread",{onSuccess:e=>{te(e==null?void 0:e.data)}}),{mutate:ne}=C(v.contractFilter,{onSuccess:e=>{J(e.data.business_unit.map(n=>({value:n,label:n.name}))),q(e.data.status.map(n=>({value:n,label:n.name})))},onError:()=>{console.error("Failed to fetch status data")}}),{mutate:oe}=C(v.contractTypeFindAll,{onSuccess:e=>{Q(e.data.list.map(n=>({value:n.id,label:n.name})))},onError:()=>{console.error("Failed to fetch contractType data")}});r.useEffect(()=>{S({data:{page:1,page_size:l}})},[l]),r.useEffect(()=>{ne({}),oe({})},[]);const re=()=>{open("/apps/contract","_blank")},k=e=>{open("/apps/contract/"+e.id+"/"+e.uuid,"_blank")},ie=async()=>{const e=new Headers;e.append("Content-Type","application/json"),e.append("Authorization",`Bearer ${B}`);const n=JSON.stringify({...x,page:1,page_size:999999,format:"excel"}),o={method:"POST",headers:e,body:n,redirect:"follow"};return fetch(F+v.contractFindAll,o).then(a=>a.json()).then(a=>a.data).catch(a=>[])},ce=async(e,n)=>{if(!D){U(!0);const o=await ie(),a=I.json_to_sheet(o,{header:j.map(b=>b.id)}),d=I.book_new();I.book_append_sheet(d,a,"Sheet1");const _=j.map(b=>b.displayName);I.sheet_add_aoa(a,[_],{origin:"A1"});const m=me(d,{bookType:"xlsx",type:"array"}),u=new Blob([m],{type:"application/octet-stream"}),c=document.createElement("a"),h=URL.createObjectURL(u);c.setAttribute("href",h),c.setAttribute("download",`${e}.xlsx`),c.style.visibility="hidden",document.body.appendChild(c),c.click(),document.body.removeChild(c),U(!1)}};return r.useEffect(()=>{V&&S({data:{...x,page:E,page_size:l}})},[E]),i("div",{className:"panel !pt-2 px-0 border-white-light dark:border-[#1b2e4b]",children:[(se||D)&&t(Te,{}),i("div",{className:"invoice-table",children:[y==="business_unit"?i("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 text-[#ffffff] text-center px-5 pt-5",children:[i("div",{className:"rounded col-span-1 md:col-span-1 p-4 bg-[#ff5f00]",children:[t("div",{className:"text-base",children:s("draft_contract")}),t("div",{className:"text-5xl",children:T.ct_status_1})]}),i("div",{className:"rounded col-span-1 md:col-span-1 p-4 bg-[#ff5f00]",children:[t("div",{className:"text-base",children:s("under_review")}),t("div",{className:"text-5xl",children:T.ct_status_2})]}),i("div",{className:"rounded col-span-1 md:col-span-1 p-4 bg-[#ff5f00]",children:[t("div",{className:"text-base",children:s("draft_approved")}),t("div",{className:"text-5xl",children:T.ct_status_3})]}),i("div",{className:"rounded col-span-1 md:col-span-1 p-4 bg-[#ff5f00]",children:[t("div",{className:"text-base",children:s("pending_approval")}),t("div",{className:"text-5xl",children:T.ct_status_4})]})]}):"",t("div",{className:"mb-4.5 mt-4 px-5 flex md:items-center md:flex-row flex-col gap-5",children:t("div",{className:"flex items-center gap-2",children:i("button",{className:"btn btn-primary gap-2",onClick:re,children:[t(ye,{}),s("add_contract")]})})}),t("div",{className:"flex w-full mb-4.5 px-5 md:items-center md:flex-row flex-col gap-5",children:t(he,{initialValues:{start_at:"",end_at:"",contract_date:"",contract_end_date:"",search:"",query:"",status_code:"",status_type:"",id_business_unit:"",contract_type_id:"",is_locked:"all"},onSubmit:(e,{resetForm:n})=>{var o,a,d,_,m,u,c,h,b,L,M,w;S({data:{start_at:"",end_at:"",query:e.search||"",page:1,page_size:l,contract_date:e.contract_date[0],contract_end_date:e.contract_date[1],status_code:((a=(o=e.status_code)==null?void 0:o.value)==null?void 0:a.status_code)||"",status_type:((_=(d=e.status_type)==null?void 0:d.value)==null?void 0:_.status_type)||"contract",id_business_unit:((m=e.id_business_unit.value)==null?void 0:m.id)||"",contract_type_id:(u=e.contract_type_id)==null?void 0:u.value,is_locked:e.is_locked.value}}),O({start_at:"",end_at:"",query:e.search||"",page:1,page_size:l,contract_date:e.contract_date[0],contract_end_date:e.contract_date[1],status_code:((h=(c=e.status_code)==null?void 0:c.value)==null?void 0:h.status_code)||"",status_type:((L=(b=e.status_type)==null?void 0:b.value)==null?void 0:L.status_type)||"contract",id_business_unit:((M=e.id_business_unit.value)==null?void 0:M.id)||"",contract_type_id:(w=e.contract_type_id)==null?void 0:w.value,is_locked:e.is_locked.value}),f(1)},onReset:()=>{S({data:{start_at:"",end_at:"",query:"",page:1,page_size:l,contract_date:"",contract_end_date:"",is_locked:"all"}}),O({start_at:"",end_at:"",query:"",page:1,page_size:l,contract_date:"",contract_end_date:"",approved_at:"",contract_type_id:"",is_locked:"all"}),f(1)},children:({setFieldValue:e,handleReset:n,values:o})=>i(be,{className:"flex flex-col flex-auto gap-2",children:[i("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5",children:[i("div",{className:"flex-1",children:[t("label",{children:s("business_unit")}),y==="business_unit"?t(g,{defaultValue:p.length===0?null:{label:p[0].label,value:p[0].value.id},value:p.length===0?null:{label:p[0].label,value:p[0].value.id},placeholder:s("select_business_unit"),className:"z-10 w-auto",options:p.map(a=>({label:a.label,value:a.value.id})),isDisabled:!0}):t(g,{value:o.id_business_unit,placeholder:s("select_business_unit"),className:"z-10 w-auto",options:p,isSearchable:!0,onChange:a=>{e("id_business_unit",a)}})]}),i("div",{className:"z-10 flex-1",children:[t("label",{children:s("contract_status")}),t(g,{value:o.status_code,placeholder:s("select_contract_status"),className:"z-10 w-auto",options:$,isSearchable:!0,onChange:a=>{e("status_code",a),e("status_type",a)}})]}),i("div",{className:"z-10 flex-1",children:[t("label",{children:s("device_lock_status")}),t(g,{value:o.is_locked,placeholder:s("select_device_lock_status"),className:"z-10 w-auto",options:[{value:"all",label:s("all")},{value:"locked",label:s("locked")},{value:"unlocked",label:s("unlocked")}],isSearchable:!0,onChange:a=>{e("is_locked",a)}})]})]}),i("div",{className:"flex flex-col sm:flex-row md:flex-row gap-5 pt-3",children:[t("div",{className:"flex-1",children:t(Ee,{label:s("search_text"),placeholder:s("search_text"),name:"search",type:"text"})}),t(ge,{label:s("contract_date"),name:"contract_date"}),i("div",{className:"flex-1",children:[t("label",{children:s("contract_type")}),t(g,{value:o.contract_type_id,placeholder:s("select_contract_type"),className:"z-9 w-auto",options:Z,onChange:a=>{e("contract_type_id",a)}})]}),i("div",{className:"flex flex-col sm:flex-row md:flex-row gap-4 flex-1 justify-end items-end",children:[t("button",{type:"submit",className:"btn btn-primary w-[100px] gap-2",children:s("search_text")}),t("button",{type:"reset",className:"btn btn-info gap-2 w-[100px]",onClick:n,children:s("clear")}),(y==="admin"||y==="business_unit")&&t("button",{type:"button",className:"btn btn-success gap-2 w-[100px]",onClick:()=>{ce(`contract_${new Date().toLocaleString()}`)},children:"Export"})]})]})]})})}),t("div",{className:"datatables pagination-padding",children:N.length===0?t("div",{className:"my-10 text-center text-gray-500",children:s("not_found_data")}):t(ue,{className:"whitespace-nowrap table-hover invoice-table",records:N,columns:[{accessor:"index",title:s("order"),textAlignment:"center",render:(e,n)=>n+1+(E-1)*l},{accessor:"business_unit",title:s("business_unit"),textAlignment:"left",sortable:!1,render:e=>t("div",{children:e.business_unit.name})},{accessor:"shop",title:s("shop"),textAlignment:"left",sortable:!1,render:e=>t("div",{children:e.shop.name})},{accessor:"id",title:s("contract_number"),textAlignment:"center",sortable:!1,render:e=>{var o;const n=(o=P==null?void 0:P.find(a=>a.id_contract===e.id))==null?void 0:o.unread;return i("div",{className:"pointer flex items-center space-x-2 active",onClick:()=>k(e),children:[t("span",{className:`w-3 h-3 rounded-full ${n>0?"bg-red-500":"bg-gray-300"}`}),t("span",{children:e.reference})]})}},{accessor:"contract_type",title:s("contract_type"),textAlignment:"center",sortable:!1,render:e=>{var n;return t("div",{children:(n=e==null?void 0:e.contract_type)==null?void 0:n.name})}},{accessor:"contract_date",title:s("contract_date"),textAlignment:"left",sortable:!1,render:e=>t("div",{className:"pointer",children:Ae(e==null?void 0:e.contract_date)??"-"})},{accessor:"customer",title:s("customer_name"),sortable:!1,render:e=>t("div",{children:e.customer.name})},{accessor:"price",title:s("product_price"),textAlignment:"right",sortable:!1,render:({price:e})=>t("div",{children:e?e.toLocaleString("en-US"):"-"})},{accessor:"down_payment",title:s("down_payment"),textAlignment:"right",sortable:!1,render:({down_payment:e})=>t("div",{children:e?e.toLocaleString("en-US"):"-"})},{accessor:"principle",title:s("lease_principal"),textAlignment:"right",sortable:!1,render:({principle:e})=>t("div",{children:e?e.toLocaleString("en-US"):"-"})},{accessor:"ins_period",title:s("installment_period"),textAlignment:"center",sortable:!1},{accessor:"status_id",title:s("contract_status"),sortable:!1,render:({status:e})=>t("div",{children:e.name})},{accessor:"customer_signature_at",title:s("online_signature"),textAlignment:"center",sortable:!1,render:e=>t("span",{className:`${e!=null&&e.customer_signature_at?"badge-outline-success":"badge-outline-danger"}`,children:e!=null&&e.customer_signature_at?t(G,{className:"w-6 h-6"}):""})},{accessor:"e_contract_status",title:s("ekyc_signature"),textAlignment:"center",sortable:!1,render:e=>t("span",{className:`${e!=null&&e.e_contract_status?"badge-outline-success":"badge-outline-danger"}`,children:e!=null&&e.e_contract_status?t(G,{className:"w-6 h-6"}):""})},{accessor:"action",title:s("actions"),sortable:!1,textAlignment:"center",render:e=>t("div",{className:"flex gap-4 items-center w-max mx-auto",children:t("button",{className:"flex cursor-pointer",onClick:()=>k(e),children:t(fe,{className:"w-4.5 h-4.5"})})})}],page:E,totalRecords:z,recordsPerPage:l,onPageChange:e=>f(e),recordsPerPageOptions:H,onRecordsPerPageChange:e=>{f(1),Y(e)},highlightOnHover:!0,paginationText:({from:e,to:n,totalRecords:o})=>`${s("showing")} ${e} ${s("to")} ${n} ${s("of")} ${o} ${s("total_pages")}`})})]})]})};export{Ke as default};
